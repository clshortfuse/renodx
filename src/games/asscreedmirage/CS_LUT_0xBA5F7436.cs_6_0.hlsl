#include "./tonemap.hlsli"

static const float _38[10] = { -0.15369999408721923828125f, 0.013500000350177288055419921875f, 0.13120000064373016357421875f, 0.2092899978160858154296875f, 0.2858000099658966064453125f, 0.513000011444091796875f, 0.66879999637603759765625f, 0.745999991893768310546875f, 0.84630000591278076171875f, 1.0134999752044677734375f };

cbuffer _19_21 : register(b0, space6) {
  float4 _21_m0[63] : packoffset(c0);
};

Texture2D<float4> _8 : register(t0, space6);
Texture3D<float4> _11 : register(t1, space6);
RWTexture3D<float4> _14 : register(u0, space6);
SamplerState _24 : register(s0, space99);
SamplerState _25 : register(s0, space7);

static uint3 gl_GlobalInvocationID;
struct SPIRV_Cross_Input {
  uint3 gl_GlobalInvocationID : SV_DispatchThreadID;
};

void comp_main() {
  float4 _67 = _8.SampleLevel(_24, 0.0f.xx, 0.0f);
  float _70 = _67.x;
  float _73 = (_70 > 0.0f) ? _70 : 9.9999999392252902907785028219223e-09f;
  float _83 = exp2((float(gl_GlobalInvocationID.x) * 0.64516127109527587890625f) + (-12.47393131256103515625f));
  float _86 = exp2((float(gl_GlobalInvocationID.y) * 0.64516127109527587890625f) + (-12.47393131256103515625f));
  float _89 = exp2((float(gl_GlobalInvocationID.z) * 0.64516127109527587890625f) + (-12.47393131256103515625f));

  // BT.2020 -> BT.709
  float _94 = mad(_89, -0.0728498995304107666015625f, mad(_86, -0.5876410007476806640625f, _83 * 1.66049110889434814453125f));
  float _100 = mad(_89, -0.008349411189556121826171875f, mad(_86, 1.1328995227813720703125f, _83 * (-0.124550521373748779296875f)));
  float _106 = mad(_89, 1.11872994899749755859375f, mad(_86, -0.100578851997852325439453125f, _83 * (-0.0181507654488086700439453125f)));
  float _115;
  float _117;
  float _119;
  if (asuint(_21_m0[0u]).x == 0u) {
    _115 = _94;
    _117 = _100;
    _119 = _106;
  } else {
    float _243 = _94 / _73;
    float _244 = _100 / _73;
    float _245 = _106 / _73;
    float _246 = dot(float3(_243, _244, _245), float3(0.2125999927520751953125f, 0.715200006961822509765625f, 0.072200000286102294921875f));
    float _254 = log2(_246 * 5464.0f);
    float _293;
    float _295;
    float _297;
    if (_254 < _21_m0[1u].y) {
      float _525;
      if (_254 > _21_m0[1u].x) {
        float _519 = (_254 - _21_m0[1u].x) / (_21_m0[1u].y - _21_m0[1u].x);
        float _520 = _519 * _519;
        _525 = (_520 * 3.0f) - ((_520 * 2.0f) * _519);
      } else {
        _525 = 0.0f;
      }
      float frontier_phi_5_8_ladder;
      float frontier_phi_5_8_ladder_1;
      float frontier_phi_5_8_ladder_2;
      if (_525 < 1.0f) {
        float _527 = 1.0f - _525;
        float _537 = mad(0.180437505245208740234375f, _245, mad(0.3575761020183563232421875f, _244, _243 * 0.41245639324188232421875f));
        float _543 = mad(0.072175003588199615478515625f, _245, mad(0.715152204036712646484375f, _244, _243 * 0.21267290413379669189453125f));
        float _552 = (_543 + _537) + mad(0.950304090976715087890625f, _245, mad(0.119191996753215789794921875f, _244, _243 * 0.01933390088379383087158203125f));
        float _553 = _537 / _552;
        float _554 = _543 / _552;
        float _555 = _21_m0[0u].y - _553;
        float _556 = _21_m0[0u].z - _554;
        float _560 = sqrt((_556 * _556) + (_555 * _555));
        bool _561 = _560 > 0.0f;
        float _567 = min(_21_m0[0u].w, _560);
        float _572 = (((_561 ? (_555 / _560) : 0.0f) * _527) * _567) + _553;
        float _576 = (_527 * ((_245 * 0.14589999616146087646484375f) + (_244 * 0.845099985599517822265625f))) + (_525 * _246);
        float _577 = max((((_561 ? (_556 / _560) : 0.0f) * _527) * _567) + _554, 0.001000000047497451305389404296875f);
        float _580 = (_572 * _576) / _577;
        float _584 = (((1.0f - _577) - _572) * _576) / _577;
        frontier_phi_5_8_ladder = mad(-0.498531401157379150390625f, _584, mad(-1.537138462066650390625f, _576, _580 * 3.240454196929931640625f));
        frontier_phi_5_8_ladder_1 = mad(0.04155600070953369140625f, _584, mad(1.87601077556610107421875f, _576, _580 * (-0.969265997409820556640625f)));
        frontier_phi_5_8_ladder_2 = mad(1.05722522735595703125f, _584, mad(-0.2040258944034576416015625f, _576, _580 * 0.0556433983147144317626953125f));
      } else {
        frontier_phi_5_8_ladder = _243;
        frontier_phi_5_8_ladder_1 = _244;
        frontier_phi_5_8_ladder_2 = _245;
      }
      _293 = frontier_phi_5_8_ladder;
      _295 = frontier_phi_5_8_ladder_1;
      _297 = frontier_phi_5_8_ladder_2;
    } else {
      _293 = _243;
      _295 = _244;
      _297 = _245;
    }
    _115 = _293 * _73;
    _117 = _295 * _73;
    _119 = _297 * _73;
  }

  float3 color_tint = lerp(1.f, _21_m0[2u].rgb, CUSTOM_COLOR_FILTER_STRENGTH);
  float exposure = _21_m0[2u].w;

  // BT.709 -> AP1 with Bradford
  float _148 = (color_tint.r * mad(_119, 0.047379501163959503173828125f, mad(_117, 0.3395229876041412353515625f, _115 * 0.613097012042999267578125f))) * exposure;
  float _149 = (color_tint.g * mad(_119, 0.013452400453388690948486328125f, mad(_117, 0.916354000568389892578125f, _115 * 0.070193700492382049560546875f))) * exposure;
  float _150 = (color_tint.b * mad(_119, 0.86981499195098876953125f, mad(_117, 0.1095699965953826904296875f, _115 * 0.020615600049495697021484375f))) * exposure;
  bool _151 = _149 < _150;
  float _152 = _151 ? _150 : _149;
  float _153 = _151 ? _149 : _150;
  bool _159 = _148 < _152;
  float _160 = _159 ? _152 : _148;
  float _162 = _159 ? _148 : _152;
  float _164 = _160 - min(_162, _153);
  float _177 = abs((_159 ? (_151 ? 0.666666686534881591796875f : (-0.3333333432674407958984375f)) : (_151 ? (-1.0f) : 0.0f)) + ((_162 - _153) / ((_164 * 6.0f) + 1.0000000133514319600180897396058e-10f)));
  float _202 = min(max((_21_m0[16u].x * ((((log2(dot(float3(_148, _149, _150), 0.3333333432674407958984375f.xxx)) * 0.071428574621677398681640625f) + 0.105280816555023193359375f) * _21_m0[3u].x) + 0.5f)) + _21_m0[16u].y, _21_m0[16u].z), _21_m0[16u].w);
  uint _203 = uint(_202);
  uint _206 = _203 + 1u;
  uint _208 = (_206 >> 2u) + 17u;
  float _62[4];
  _62[0u] = _21_m0[_208].x;
  _62[1u] = _21_m0[_208].y;
  _62[2u] = _21_m0[_208].z;
  _62[3u] = _21_m0[_208].w;
  uint _225 = (_203 >> 2u) + 17u;
  float _63[4];
  _63[0u] = _21_m0[_225].x;
  _63[1u] = _21_m0[_225].y;
  _63[2u] = _21_m0[_225].z;
  _63[3u] = _21_m0[_225].w;
  uint _236 = _203 & 3u;
  float _260;
  float _262;
  float _264;
  float _266;
  uint _268;
  _260 = 0.0f;
  _262 = 0.0f;
  _264 = 0.0f;
  _266 = 0.0f;
  _268 = 0u;
  float _261;
  float _263;
  float _265;
  float _267;
  for (;;) {
    float _273 = _38[_268] - _177;
    float _277 = exp2((_273 * _273) * (-128.0f));
    uint _278 = _268 + 4u;
    _261 = (_21_m0[_278].x * _277) + _260;
    _263 = (_21_m0[_278].y * _277) + _262;
    _265 = (_21_m0[_278].z * _277) + _264;
    _267 = _277 + _266;
    uint _269 = _268 + 1u;
    if (_269 == 10u) {
      break;
    } else {
      _260 = _261;
      _262 = _263;
      _264 = _265;
      _266 = _267;
      _268 = _269;
    }
  }
  float _301 = clamp(_21_m0[3u].y * (_164 / (_160 + 1.0000000133514319600180897396058e-10f)), 0.0f, 1.0f);
  float _302 = 1.0f / _267;
  float _306 = sqrt(_301);
  float _315 = frac(((_302 * _261) * _306) + _177);
  float _317 = clamp(((((_302 * _263) + (-1.0f)) * _306) + 1.0f) * _301, 0.0f, 1.0f);
  float _319 = clamp(((((_302 * _265) + (-1.0f)) * _306) + 1.0f) * (((_62[_206 & 3u] - _63[_236]) * (_202 - float(_203))) + _63[_236]), 0.0f, 1.0f);
  float _324 = exp2((_319 * 14.0f) + (-8.47393131256103515625f));
  float _356 = ((min(max(abs((frac(_315 + 1.0f) * 6.0f) + (-3.0f)) + (-1.0f), 0.0f), 1.0f) + (-1.0f)) * _317) + 1.0f;
  float _357 = ((min(max(abs((frac(_315 + 0.666666686534881591796875f) * 6.0f) + (-3.0f)) + (-1.0f), 0.0f), 1.0f) + (-1.0f)) * _317) + 1.0f;
  float _358 = ((min(max(abs((frac(_315 + 0.3333333432674407958984375f) * 6.0f) + (-3.0f)) + (-1.0f), 0.0f), 1.0f) + (-1.0f)) * _317) + 1.0f;
  float _364 = 1.0f / dot(float3(_356, _357, _358), 0.3333333432674407958984375f.xxx);
  float _365 = (_356 * _324) * _364;
  float _366 = (_357 * _324) * _364;
  float _368 = (_364 * _324) * _358;
  float _398 = min(max(abs((frac(_21_m0[14u].z + 1.0f) * 6.0f) + (-3.0f)) + (-1.0f), 0.0f), 1.0f);
  float _399 = min(max(abs((frac(_21_m0[14u].z + 0.666666686534881591796875f) * 6.0f) + (-3.0f)) + (-1.0f), 0.0f), 1.0f);
  float _400 = min(max(abs((frac(_21_m0[14u].z + 0.3333333432674407958984375f) * 6.0f) + (-3.0f)) + (-1.0f), 0.0f), 1.0f);
  float _407 = 1.0f / dot(float3(_398, _399, _400), 0.3333333432674407958984375f.xxx);
  float _432 = min(max(abs((frac(_21_m0[15u].x + 1.0f) * 6.0f) + (-3.0f)) + (-1.0f), 0.0f), 1.0f);
  float _433 = min(max(abs((frac(_21_m0[15u].x + 0.666666686534881591796875f) * 6.0f) + (-3.0f)) + (-1.0f), 0.0f), 1.0f);
  float _434 = min(max(abs((frac(_21_m0[15u].x + 0.3333333432674407958984375f) * 6.0f) + (-3.0f)) + (-1.0f), 0.0f), 1.0f);
  float _441 = 1.0f / dot(float3(_432, _433, _434), 0.3333333432674407958984375f.xxx);
  float _446 = _21_m0[14u].w * 0.75f;
  float _455 = _21_m0[15u].y * 0.75f;
  float _459 = _455 * (((_432 * _324) * _441) - _365);
  float _460 = _455 * (((_433 * _324) * _441) - _366);
  float _461 = _455 * (((_434 * _324) * _441) - _368);
  float _470 = clamp(((_319 - _21_m0[14u].x) * _21_m0[14u].y) + 0.5f, 0.0f, 1.0f);
  float _476 = (_470 * _470) * (3.0f - (_470 * 2.0f));

  float3 color_final = float3(
      (_459 + _365) + (_476 * ((_446 * (((_398 * _324) * _407) - _365)) - _459)),
      (_460 + _366) + (_476 * ((_446 * (((_399 * _324) * _407) - _366)) - _460)),
      (_461 + _368) + (_476 * ((_446 * (((_400 * _324) * _407) - _368)) - _461)));

#if 1
  color_final = ApplyUserColorGradingAP1(color_final);
#endif

#if 1
  float3 color_encoded = log2(color_final) * 0.0500000007450580596923828125f + 0.6236965656280517578125f;
  float3 color_pq = _11.SampleLevel(_25, saturate(color_encoded) * 0.96875f + 0.015625f, 0.0f).xyz;
#else
  float3 color_pq = ApplyToneMapEncodePQ(color_final, 400.f, 100.f);
#endif
  _14[gl_GlobalInvocationID] = float4(color_pq, 1.0f);
}

[numthreads(16, 16, 1)]
void main(SPIRV_Cross_Input stage_input) {
  gl_GlobalInvocationID = stage_input.gl_GlobalInvocationID;
  comp_main();
}
