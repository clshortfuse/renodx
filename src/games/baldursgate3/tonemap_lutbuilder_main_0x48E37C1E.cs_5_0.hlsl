#include "./common.hlsli"

cbuffer cb0 : register(b0) {
  float4 cb0[9];
}

RWTexture3D<float4> u0 : register(u0);  // unknown dcl_: dcl_uav_typed_texture3d (unorm,unorm,unorm,unorm) u0

// 3Dmigoto declarations
#define cmp -

[numthreads(16, 16, 2)]  // unknown dcl_: dcl_thread_group 16, 16, 2
void main(uint3 vThreadID: SV_DispatchThreadID) {
  float4 r0, r1, r2, r3, r4, r5, r6, r7, r8, r9, r10, r11, r12, r13, r14, r15, r16, r17, r18, r19, r20, r21;
  uint4 bitmask, uiDest;
  float4 fDest;

  bool hdr_enabled = (asuint(cb0[6].z) != 0u);
  float game_nits = cb0[1].y;
  float contrast = cb0[6].y;
  float cb05w = cb0[5].w;  // cb0[5].w, related to saturation
  float cb00x = cb0[0].x;  // cb0[0].x, related to shadows, roughly -4.5
  float cb08w = cb0[8].w;  // cb0[8].w, setting above 38.5 makes the screen black, otherwise it does nothing

  r0.xyz = (uint3)vThreadID.xyz;
  r0.xyz = r0.xyz * float3(0.278095275, 0.278095275, 0.278095275) + float3(-9.72000027, -9.72000027, -9.72000027);
  r0.xyz = exp2(r0.xyz);
  r0.w = max(r0.y, r0.z);
  r0.w = max(r0.x, r0.w);
  r0.xyz = r0.www + -r0.xyz;
  r0.xyz = r0.xyz / r0.www;
  r1.xyz = cmp(r0.xyz < float3(0.814999998, 0.802999973, 0.99000001));
  r2.xyz = float3(-0.814999998, -0.802999973, -0.99000001) + r0.xyz;
  r3.xyz = float3(3.05528307, 3.49726105, 98.7060318) * r2.xyz;
  r2.xyz = float3(1, 1, 0.99999994) * r2.xyz;
  r3.xyz = log2(r3.xyz);
  r3.xyz = float3(1.20000005, 1.20000005, 1.20000005) * r3.xyz;
  r3.xyz = exp2(r3.xyz);
  r3.xyz = float3(1, 1, 1) + r3.xyz;
  r3.xyz = log2(r3.xyz);
  r3.xyz = float3(0.833333313, 0.833333313, 0.833333313) * r3.xyz;
  r3.xyz = exp2(r3.xyz);
  r2.xyz = r2.xyz / r3.xyz;
  r2.xyz = float3(0.814999998, 0.802999973, 0.99000001) + r2.xyz;
  r0.xyz = r1.xyz ? r0.xyz : r2.xyz;
  r0.xyz = -r0.xyz * r0.www + r0.www;

  float3 untonemapped_ap1 = r0.rgb;

#if RENODX_TONE_MAP_TYPE
  r0.rgb = float3(0.18f, 0.18f, 0.18f);
#endif

  r1.x = dot(float3(0.695452213, 0.140678704, 0.163869068), r0.xyz);
  r1.y = dot(float3(0.0447945632, 0.859671116, 0.0955343172), r0.xyz);
  r1.z = dot(float3(-0.00552588282, 0.00402521016, 1.00150073), r0.xyz);
  r0.xyzw = hdr_enabled ? float4(200, 1, 1.14999998, 0.899999976) : float4(125, 0.899999976, 1.03499997, 1);
  r1.w = max(r1.y, r1.z);
  r1.w = max(r1.x, r1.w);
  r2.x = cmp(0 >= r1.w);
  r2.yzw = r1.xyz / r1.www;
  r2.yzw = r2.xxx ? float3(0, 0, 0) : r2.yzw;
  r3.x = cmp(r2.z >= r2.w);
  r3.x = r3.x ? 1.000000 : 0;
  r4.xy = r2.wz;
  r4.zw = float2(-1, 0.666666687);
  r5.xy = -r4.xy + r2.zw;
  r5.zw = float2(1, -1);
  r3.xyzw = r3.xxxx * r5.xyzw + r4.xyzw;
  r4.x = cmp(r2.y >= r3.x);
  r4.x = r4.x ? 1.000000 : 0;
  r5.xyz = r3.xyw;
  r5.w = r2.y;
  r3.xyw = r5.wyx;
  r3.xyzw = r3.xyzw + -r5.xyzw;
  r3.xyzw = r4.xxxx * r3.xyzw + r5.xyzw;
  r4.x = min(r3.w, r3.y);
  r3.x = -r4.x + r3.x;
  r3.y = r3.w + -r3.y;
  r3.x = r3.x * 6 + 1.00000001e-10;
  r3.x = r3.y / r3.x;
  r3.x = r3.z + r3.x;
  r3.y = 6 * abs(r3.x);
  r3.xzw = abs(r3.xxx) * float3(6, 6, 6) + float3(-3, -4, 9.99999997e-07);
  r3.xz = saturate(r3.xz);
  r3.x = r3.x + -r3.z;
  r3.z = (uint)r3.w;
  r3.z = (int)r3.z & 1;
  r3.zw = r3.zz ? float2(1, 0) : float2(-1, 1);
  r3.y = frac(r3.y);
  r3.y = r3.z * r3.y + r3.w;
  r4.xyz = cmp(float3(0, 0, 0) >= r2.yzw);
  r5.xyz = log2(r2.yzw);
  r6.xyz = r5.xyz * r0.yyy;
  r6.xyz = exp2(r6.xyz);
  r3.z = r3.y + -r3.x;
  r5.xyz = r5.xyz * r0.zzz;
  r5.xyz = exp2(r5.xyz);
  r5.xyz = r5.xyz * r3.xxx;
  r3.xzw = r6.xyz * r3.zzz + r5.xyz;
  r4.w = 1 + -r3.y;
  r3.xzw = r2.yzw * r4.www + r3.xzw;
  r3.xzw = r4.xyz ? r2.yzw : r3.xzw;
  r5.xyz = log2(r3.xzw);
  r5.xyz = r5.xyz * r0.yyy;
  r5.xyz = exp2(r5.xyz);
  r3.xzw = -r5.xyz + r3.xzw;
  r3.xyz = r3.yyy * r3.xzw + r5.xyz;
  r2.yzw = r4.xyz ? r2.yzw : r3.xyz;
  r0.y = r1.w * r1.w + r1.w;
  r0.y = 0.00499999989 + r0.y;
  r0.y = saturate(r1.w / r0.y);
  r0.y = r2.x ? 0 : r0.y;
  r0.y = r0.y * r0.y;
  r2.xyz = r2.yzw * r1.www + -r1.xyz;
  r1.xyz = r0.yyy * r2.xyz + r1.xyz;
  r0.y = max(r1.y, r1.z);
  r0.y = max(r1.x, r0.y);
  r1.w = cmp(0 >= r0.y);
  r2.xyz = r1.xyz / r0.yyy;
  r2.xyz = r1.www ? float3(0, 0, 0) : r2.xyz;
  r2.w = cmp(r2.y >= r2.z);
  r2.w = r2.w ? 1.000000 : 0;
  r3.xy = r2.zy;
  r3.zw = float2(-1, 0.666666687);
  r4.xy = -r3.xy + r2.yz;
  r4.zw = float2(1, -1);
  r3.xyzw = r2.wwww * r4.xyzw + r3.xyzw;
  r2.w = cmp(r2.x >= r3.x);
  r2.w = r2.w ? 1.000000 : 0;
  r4.xyz = r3.xyw;
  r4.w = r2.x;
  r3.xyw = r4.wyx;
  r3.xyzw = r3.xyzw + -r4.xyzw;
  r3.xyzw = r2.wwww * r3.xyzw + r4.xyzw;
  r2.w = min(r3.w, r3.y);
  r2.w = r3.x + -r2.w;
  r3.x = r3.w + -r3.y;
  r2.w = r2.w * 6 + 1.00000001e-10;
  r2.w = r3.x / r2.w;
  r2.w = r3.z + r2.w;
  r3.xy = saturate(abs(r2.ww) * float2(6, 6) + float2(-2, -3));
  r2.w = r3.x + -r3.y;
  r3.xyz = cmp(float3(0, 0, 0) >= r2.xyz);
  r4.xyz = log2(r2.xyz);
  r4.xyz = r4.xyz * r0.www;
  r4.xyz = exp2(r4.xyz);
  r4.xyz = r4.xyz + -r2.xyz;
  r4.xyz = r2.www * r4.xyz + r2.xyz;
  r2.xyz = r3.xyz ? r2.xyz : r4.xyz;
  r0.w = 1 + r0.y;
  r0.w = r0.w * r0.w;
  r0.w = rcp(r0.w);
  r0.w = saturate(1 + -r0.w);
  r0.w = r1.w ? 0 : r0.w;
  r2.xyz = r2.xyz * r0.yyy + -r1.xyz;
  r1.xyz = r0.www * r2.xyz + r1.xyz;
  r0.y = cmp(hdr_enabled);  // r0.y = cmp(asuint(cb0[6].z) == 1u);
  r2.xyw = max(float3(0, 0, 0), r1.yzx);
  r0.w = cmp(r2.x >= r2.y);
  r0.w = r0.w ? 1.000000 : 0;
  r3.xy = r2.yx;
  r3.zw = float2(-1, 0.666666687);
  r4.xy = -r3.xy + r2.xy;
  r4.zw = float2(1, -1);
  r3.xyzw = r0.wwww * r4.xyzw + r3.xyzw;
  r0.w = cmp(r2.w >= r3.x);
  r0.w = r0.w ? 1.000000 : 0;
  r2.xyz = r3.xyw;
  r3.xyw = r2.wyx;
  r3.xyzw = r3.xyzw + -r2.xyzw;
  r2.xyzw = r0.wwww * r3.xyzw + r2.xyzw;
  r0.w = min(r2.w, r2.y);
  r0.w = r2.x + -r0.w;
  r1.w = r2.w + -r2.y;
  r0.w = r0.w * 6 + 1.00000001e-10;
  r0.w = r1.w / r0.w;
  r0.w = r2.z + r0.w;
  r2.xyzw = -abs(r0.wwww) * float4(540, 360, 360, 360) + float4(92.5999985, 123.440002, 325, 375);
  r3.xyz = float3(92.5999985, -30.8400002, 92.5999985) + -r2.xyy;
  r1.w = 1 / -r2.x;
  r1.w = saturate(r3.x * r1.w);
  r2.x = r1.w * -2 + 3;
  r1.w = r1.w * r1.w;
  r1.w = r2.x * r1.w;
  r1.w = 1.25 * r1.w;
  r2.x = 1 / r3.y;
  r2.x = saturate(r3.z * r2.x);
  r2.y = r2.x * -2 + 3;
  r2.x = r2.x * r2.x;
  r2.x = r2.y * r2.x;
  r3.xy = abs(r0.ww) * float2(360, 360) + float2(-30.5, -352);
  r2.y = saturate(r3.x + r3.x);
  r2.x = r2.x * 1.25 + -r1.w;
  r1.w = saturate(r2.y * r2.x + r1.w);
  r2.x = 1 / r2.z;
  r2.x = saturate(r2.w * r2.x);
  r2.y = r2.x * -2 + 3;
  r2.x = r2.x * r2.x;
  r2.z = r2.y * r2.x;
  r2.w = saturate(0.0199999996 * r3.y);
  r2.x = r2.y * r2.x + r2.w;
  r0.w = cmp(abs(r0.w) < 0.977777779);
  r0.w = r0.w ? r2.z : r2.x;
  r0.w = r1.w + r0.w;
  r0.w = min(1, r0.w);
  r1.w = max(r1.y, r1.z);
  r1.w = max(r1.x, r1.w);
  r2.x = min(r1.y, r1.z);
  r2.x = min(r2.x, r1.x);
  r1.w = -r2.x + r1.w;
  r1.w = cmp(r1.w < 0.00100000005);
  r1.w = (int)r0.y | (int)r1.w;
  r0.w = r1.w ? 0 : r0.w;
  r1.w = cb0[8].x + -cb00x;
  r1.w = r0.w * r1.w + cb00x;

  r2.x = 3.32192802 * cb08w;
  r2.x = exp2(r2.x);

  r2.x = -cb05w + r2.x;
  r2.x = r0.w * r2.x + cb05w;  // peak is set here? this value is equal to peak, later used for clamp

  r3.x = dot(float2(0.952552378, 9.36786018e-05), r1.xz);
  r3.y = dot(float3(0.343966454, 0.728166103, -0.0721325427), r1.xyz);
  r3.z = r1.z * r0.x;
  r0.z = 1.00882518;
  r1.xyz = r3.xyz * r0.xxz;
  r3.x = dot(float3(0.732800007, 0.4296, -0.162400007), r1.xyz);
  r3.y = dot(float3(-0.703599989, 1.69749999, 0.00609999988), r1.xyz);
  r3.z = dot(float3(0.00300000003, 0.0136000002, 0.983399987), r1.xyz);
  r1.xyz = float3(0.98481679, 1.00196505, 1.07822645) * r3.xyz;
  r0.z = dot(float3(1.09612381, -0.278869003, 0.182745174), r1.xyz);
  r2.y = dot(float3(0.454369038, 0.473533154, 0.0720978007), r1.xyz);
  r1.z = dot(float3(-0.00962761045, -0.00569802988, 1.01532567), r1.xyz);
  r2.zw = float2(1.14999998, 0.300000012) * r0.zz;
  r1.x = -r1.z * 0.150000006 + r2.z;
  r1.y = r2.y * 0.699999988 + r2.w;
  r3.x = dot(float3(0.404802799, 0.57999903, 0.0246349014), r1.xyz);
  r3.y = dot(float3(-0.201509997, 1.14217591, 0.0315739214), r1.xyz);
  r3.z = dot(float3(-0.0166008007, 0.264800012, 0.668479919), r1.xyz);
  r1.xyz = float3(9.99999975e-05, 9.99999975e-05, 9.99999975e-05) * abs(r3.xyz);
  r1.xyz = log2(r1.xyz);
  r1.xyz = float3(0.159301758, 0.159301758, 0.159301758) * r1.xyz;
  r1.xyz = exp2(r1.xyz);
  r2.yzw = cmp(r3.xyz == float3(0, 0, 0));
  r4.xyz = cmp(float3(0, 0, 0) < r3.xyz);
  r3.xyz = cmp(r3.xyz < float3(0, 0, 0));
  r3.xyz = (int3)-r4.xyz + (int3)r3.xyz;
  r3.xyz = (int3)r3.xyz;
  r4.xyz = r1.xyz * float3(18.8515625, 18.8515625, 18.8515625) + float3(0.8359375, 0.8359375, 0.8359375);
  r1.xyz = r1.xyz * float3(18.6875, 18.6875, 18.6875) + float3(1, 1, 1);
  r1.xyz = r4.xyz / r1.xyz;
  r1.xyz = log2(r1.xyz);
  r1.xyz = float3(134.034378, 134.034378, 134.034378) * r1.xyz;
  r1.xyz = exp2(r1.xyz);
  r1.xyz = r3.xyz * r1.xyz;
  r1.xyz = r2.yzw ? float3(0, 0, 0) : r1.xyz;
  r3.x = dot(float3(3.52399993, -4.06670809, 0.54270798), r1.xyz);
  r3.y = dot(float3(0.199075997, 1.09679902, -1.29587495), r1.xyz);
  r0.z = max(0, r1.y);
  r4.xyzw = hdr_enabled ? float4(218.604858, -32.6717339, 217.811554, 140) : float4(136.628036, -20.4198341, 136.132233, 87.5);
  r4.x = r4.x + r4.y;
  r1.xy = hdr_enabled ? float2(57.0273552, 0.898262382) : float2(35.6420975, 0.843698382);
  r4.y = r4.w + r1.x;
  r1.x = dot(float3(-0.201509997, 1.14217591, 0.0315739214), r4.xyz);
  r1.x = 9.99999975e-05 * r1.x;
  r1.x = log2(r1.x);
  r1.x = 0.159301758 * r1.x;
  r1.x = exp2(r1.x);
  r1.xz = r1.xx * float2(18.8515625, 18.6875) + float2(0.8359375, 1);
  r1.x = r1.x / r1.z;
  r1.x = log2(r1.x);
  r1.z = cmp(0 >= r0.z);
  r2.y = log2(r0.z);
  r2.y = 0.00746077253 * r2.y;
  r2.y = exp2(r2.y);
  r2.y = min(1.00870001, r2.y);
  r2.z = cmp(0.8359375 >= r2.y);
  r2.w = cmp(0 < r0.z);
  r2.w = (int)-r2.w;
  r3.z = -0.8359375 + r2.y;
  r2.y = -r2.y * 18.6875 + 18.8515625;
  r2.y = r3.z / r2.y;
  r2.y = log2(r2.y);
  r2.y = 6.27739477 * r2.y;
  r2.y = exp2(r2.y);
  r2.y = r2.w * r2.y;
  r2.y = 10285.5273 * r2.y;
  r1.z = (int)r1.z | (int)r2.z;
  r1.z = r1.z ? 0 : r2.y;
  r1.z = r1.z / r0.x;
  r2.y = max(6.10351562e-05, r1.z);
  r2.y = log2(r2.y);
  r2.z = 0.30103001 * r2.y;
  r2.w = cmp(r1.w >= r2.z);
  if (r2.w != 0) {
    r2.w = -cb0[0].z * r1.w + cb0[0].y;
    r2.w = r2.z * cb0[0].z + r2.w;
  } else {
    r3.z = cb0[8].y + -cb0[0].w;
    r3.z = r0.w * r3.z + cb0[0].w;
    r3.w = cmp(r2.z < r3.z);
    if (r3.w != 0) {
      r3.w = r2.y * 0.30103001 + -r1.w;
      r3.w = 3 * r3.w;
      r1.w = r3.z + -r1.w;
      r1.w = r3.w / r1.w;
      r3.w = (int)r1.w;
      r4.x = trunc(r1.w);
      r4.y = -r4.x + r1.w;
      r5.xyzw = cmp((int4)r3.wwww == int4(0, 1, 2, 3));
      r6.xy = cmp((int2)r3.ww == int2(4, 5));
      r5.xyzw = r5.xyzw ? float4(1, 1, 1, 1) : 0;
      r6.xy = r6.xy ? float2(1, 1) : 0;
      r1.w = dot(r5.xyz, cb0[2].yzw);
      r1.w = r5.w * cb0[3].x + r1.w;
      r1.w = r6.x * cb0[3].y + r1.w;
      r5.x = r6.y * cb0[3].z + r1.w;
      r6.xyzw = (int4)r3.wwww + int4(1, 1, 2, 2);
      r7.xyzw = cmp((int4)r6.yyyy == int4(0, 1, 2, 3));
      r8.xyzw = cmp((int4)r6.xyzw == int4(4, 5, 4, 5));
      r7.xyzw = r7.xyzw ? float4(1, 1, 1, 1) : 0;
      r8.xyzw = r8.xyzw ? float4(1, 1, 1, 1) : 0;
      r1.w = dot(r7.xyz, cb0[2].yzw);
      r1.w = r7.w * cb0[3].x + r1.w;
      r1.w = r8.x * cb0[3].y + r1.w;
      r5.y = r8.y * cb0[3].z + r1.w;
      r6.xyzw = cmp((int4)r6.wwww == int4(0, 1, 2, 3));
      r6.xyzw = r6.xyzw ? float4(1, 1, 1, 1) : 0;
      r1.w = dot(r6.xyz, cb0[2].yzw);
      r1.w = r6.w * cb0[3].x + r1.w;
      r1.w = r8.z * cb0[3].y + r1.w;
      r5.z = r8.w * cb0[3].z + r1.w;
      r4.x = r4.y * r4.y;
      r6.x = dot(r5.xzy, float3(0.5, 0.5, -1));
      r6.y = dot(r5.xy, float2(-1, 1));
      r6.z = dot(r5.xy, float2(0.5, 0.5));
      r4.z = 1;
      r2.w = dot(r4.xyz, r6.xyz);
    } else {
      r1.w = cb0[7].x + -cb0[3].w;
      r1.w = r0.w * r1.w + cb0[3].w;
      r4.xyzw = cb0[7].yzww + -cb0[4].xyzw;
      r4.xyzw = r0.wwww * r4.xyzw + cb0[4].xyzw;
      r3.w = cb0[7].w + -cb0[5].x;
      r3.w = r0.w * r3.w + cb0[5].x;
      r5.xy = cb0[8].zw + -cb0[1].zw;
      r5.xy = r0.ww * r5.xy + cb0[1].zw;
      r5.z = cmp(r2.z < r5.x);
      r2.y = r2.y * 0.30103001 + -r3.z;
      r2.y = 3 * r2.y;
      r3.z = r5.x + -r3.z;
      r2.y = r2.y / r3.z;
      r3.z = (int)r2.y;
      r5.w = trunc(r2.y);
      r6.y = -r5.w + r2.y;
      r7.xyzw = cmp((int4)r3.zzzz == int4(0, 1, 2, 3));
      r8.xy = cmp((int2)r3.zz == int2(4, 5));
      r7.xyzw = r7.xyzw ? float4(1, 1, 1, 1) : 0;
      r8.xy = r8.xy ? float2(1, 1) : 0;
      r2.y = r7.y * r4.x;
      r2.y = r7.x * r1.w + r2.y;
      r2.y = r7.z * r4.y + r2.y;
      r2.y = r7.w * r4.z + r2.y;
      r2.y = r8.x * r4.w + r2.y;
      r7.x = r8.y * r3.w + r2.y;
      r8.xyzw = (int4)r3.zzzz + int4(1, 1, 2, 2);
      r9.xyzw = cmp((int4)r8.yyyy == int4(0, 1, 2, 3));
      r10.xyzw = cmp((int4)r8.xyzw == int4(4, 5, 4, 5));
      r9.xyzw = r9.xyzw ? float4(1, 1, 1, 1) : 0;
      r10.xyzw = r10.xyzw ? float4(1, 1, 1, 1) : 0;
      r2.y = r9.y * r4.x;
      r2.y = r9.x * r1.w + r2.y;
      r2.y = r9.z * r4.y + r2.y;
      r2.y = r9.w * r4.z + r2.y;
      r2.y = r10.x * r4.w + r2.y;
      r7.y = r10.y * r3.w + r2.y;
      r8.xyzw = cmp((int4)r8.wwww == int4(0, 1, 2, 3));
      r8.xyzw = r8.xyzw ? float4(1, 1, 1, 1) : 0;
      r2.y = r8.y * r4.x;
      r1.w = r8.x * r1.w + r2.y;
      r1.w = r8.z * r4.y + r1.w;
      r1.w = r8.w * r4.z + r1.w;
      r1.w = r10.z * r4.w + r1.w;
      r7.z = r10.w * r3.w + r1.w;
      r6.x = r6.y * r6.y;
      r4.x = dot(r7.xzy, float3(0.5, 0.5, -1));
      r4.y = dot(r7.xy, float2(-1, 1));
      r4.z = dot(r7.xy, float2(0.5, 0.5));
      r6.z = 1;
      r1.w = dot(r6.xyz, r4.xyz);
      r2.y = -cb0[2].x * r5.x + r5.y;
      r2.y = r2.z * cb0[2].x + r2.y;
      r2.w = r5.z ? r1.w : r2.y;
    }
  }
  r1.w = 3.32192802 * r2.w;
  r1.w = exp2(r1.w);
  r2.y = cmp(0 >= r1.w);
  r2.z = 9.72239795e-05 * r1.w;
  r2.z = log2(r2.z);
  r2.z = 0.159301758 * r2.z;
  r2.z = exp2(r2.z);
  r2.w = cmp(r1.w == 0.000000);
  r1.w = cmp(0 < r1.w);
  r1.w = (int)-r1.w;
  r3.zw = r2.zz * float2(18.8515625, 18.6875) + float2(0.8359375, 1);
  r2.z = r3.z / r3.w;
  r2.z = log2(r2.z);
  r2.z = 134.034378 * r2.z;
  r2.z = exp2(r2.z);
  r1.w = r2.z * r1.w;
  r2.y = (int)r2.y | (int)r2.w;
  r1.w = r2.y ? 0 : r1.w;
  r2.yz = cmp(r3.xy == float2(0, 0));
  r2.y = r2.z ? r2.y : 0;
  r2.z = min(abs(r3.y), abs(r3.x));
  r2.w = max(abs(r3.y), abs(r3.x));
  r2.w = 1 / r2.w;
  r2.z = r2.z * r2.w;
  r2.w = r2.z * r2.z;
  r3.z = r2.w * 0.0208350997 + -0.0851330012;
  r3.z = r2.w * r3.z + 0.180141002;
  r3.z = r2.w * r3.z + -0.330299497;
  r2.w = r2.w * r3.z + 0.999866009;
  r3.z = r2.z * r2.w;
  r3.w = cmp(abs(r3.x) < abs(r3.y));
  r3.z = r3.z * -2 + 1.57079637;
  r3.z = r3.w ? r3.z : 0;
  r2.z = r2.z * r2.w + r3.z;
  r2.w = cmp(r3.x < -r3.x);
  r2.w = r2.w ? -3.141593 : 0;
  r2.z = r2.z + r2.w;
  r2.w = min(r3.y, r3.x);
  r3.z = max(r3.y, r3.x);
  r2.w = cmp(r2.w < -r2.w);
  r3.z = cmp(r3.z >= -r3.z);
  r2.w = r2.w ? r3.z : 0;
  r2.z = r2.w ? -r2.z : r2.z;
  r2.z = r2.z * 57.2957764 + 360;
  r2.z = 0.00277777785 * r2.z;
  r2.w = cmp(r2.z >= -r2.z);
  r2.z = frac(r2.z);
  r2.z = r2.w ? r2.z : -r2.z;
  r2.z = 360 * r2.z;
  r2.y = r2.y ? 0 : r2.z;
  r2.z = 89.038002 + r2.y;
  r2.z = 0.0174532942 * r2.z;
  r2.z = cos(r2.z);
  r2.z = 1.01499999 + r2.z;
  r2.w = cmp(r1.w == 0.000000);
  r3.z = cmp(0 < r1.w);
  r3.w = cmp(r1.w < 0);
  r3.z = (int)-r3.z + (int)r3.w;
  r3.z = (int)r3.z;
  r3.w = log2(abs(r1.w));
  r4.xy = float2(0.964449048, 0.00746077253) * r3.ww;
  r4.xy = exp2(r4.xy);
  r3.w = r4.x * r3.z;
  r3.w = 100 * r3.w;
  r2.w = r2.w ? 0 : r3.w;
  r4.xzw = float3(129.269333, 104.546814, 145.274094) * r1.xxx;
  r4.xzw = exp2(r4.xzw);
  r5.x = r2.w / r4.x;
  r2.w = dot(r3.xy, r3.xy);
  r2.w = log2(r2.w);
  r2.w = 0.370000005 * r2.w;
  r2.w = exp2(r2.w);
  r2.z = log2(r2.z);
  r2.zw = float2(0.0680000037, 100) * r2.zw;
  r2.z = exp2(r2.z);
  r2.z = r2.z * r1.y;
  r3.x = 0.891250968 * r4.z;
  r3.x = r2.z / r3.x;
  r2.w = r3.x * r2.w;
  r1.z = cmp(r1.z >= 0.180000007);
  if (r1.z != 0) {
    r3.xyw = hdr_enabled ? float3(4, 8.49391937, 8.5913353) : float3(3.5, 7.94148684, 8.04371071);
    r1.z = r3.y / r3.w;
    r1.z = log2(r1.z);
    r1.z = 134.034378 * r1.z;
    r1.z = exp2(r1.z);
    r3.y = cmp(0 >= cb0[5].z);
    r3.w = 0.972239852 * cb0[5].z;
    r3.w = 9.99999975e-05 * abs(r3.w);
    r3.w = log2(r3.w);
    r3.w = 0.159301758 * r3.w;
    r3.w = exp2(r3.w);
    r4.x = cmp(cb0[5].z == 0.000000);
    r4.z = cmp(0 < cb0[5].z);
    r5.w = cmp(cb0[5].z < 0);
    r4.z = (int)-r4.z + (int)r5.w;
    r4.z = (int)r4.z;
    r6.xy = r3.ww * float2(18.8515625, 18.6875) + float2(0.8359375, 1);
    r3.w = r6.x / r6.y;
    r3.w = log2(r3.w);
    r3.w = 134.034378 * r3.w;
    r3.w = exp2(r3.w);
    r3.w = r4.z * r3.w;
    r3.y = (int)r3.y | (int)r4.x;
    r3.y = r3.y ? 0 : r3.w;
    r3.y = r3.y + r0.z;
    r1.z = r3.y + -r1.z;
    r1.z = max(5.96046448e-08, r1.z);
    r1.z = log2(r1.z);
    r3.y = max(5.96046448e-08, r1.w);
    r3.y = log2(r3.y);
    r3.y = 0.30103001 * r3.y;
    r1.z = r1.z * 0.30103001 + -r3.y;
    r3.y = r1.z * r3.x;
    r6.xyzw = r0.yyyy ? float4(0.699999988, -0.699999988, 65503.3008, 0.300000012) : float4(0.75, -0.75, 65503.25, 0.25);
    r3.w = r6.w / r6.z;
    r3.w = log2(r3.w);
    r3.w = -1.20000005 * r3.w;
    r3.w = exp2(r3.w);
    r3.w = -1 + r3.w;
    r3.w = log2(r3.w);
    r3.w = 0.833333313 * r3.w;
    r3.w = exp2(r3.w);
    r3.w = r6.z / r3.w;
    r4.x = cmp(r3.y < r6.x);
    r1.z = r1.z * r3.x + r6.y;
    r3.x = r1.z / r3.w;
    r3.x = log2(r3.x);
    r3.x = 1.20000005 * r3.x;
    r3.x = exp2(r3.x);
    r3.x = 1 + r3.x;
    r3.x = log2(r3.x);
    r3.x = 0.833333313 * r3.x;
    r3.x = exp2(r3.x);
    r1.z = r1.z / r3.x;
    r1.z = r6.x + r1.z;
    r1.z = saturate(r4.x ? r3.y : r1.z);
    r3.x = cmp(0.800000012 < r1.z);
    r3.y = -0.800000012 + r1.z;
    r3.y = r3.y * 5 + 1;
    r3.y = -1 / r3.y;
    r3.y = 1 + r3.y;
    r3.y = r3.y * 0.200000003 + 0.800000012;
    r1.z = r3.x ? r3.y : r1.z;
    r1.z = 1 + -r1.z;
  } else {
    r1.z = 1;
  }
  r3.x = cmp(0 >= r1.w);
  r3.y = min(1.00870001, r4.y);
  r3.w = cmp(0.8359375 >= r3.y);
  r4.x = -0.8359375 + r3.y;
  r3.y = -r3.y * 18.6875 + 18.8515625;
  r3.y = r4.x / r3.y;
  r3.y = log2(r3.y);
  r3.y = 6.27739477 * r3.y;
  r3.y = exp2(r3.y);
  r3.y = r3.z * r3.y;
  r3.y = 10285.5273 * r3.y;
  r3.x = (int)r3.x | (int)r3.w;
  r3.x = r3.x ? 0 : r3.y;
  r3.x = -cb0[5].z + r3.x;
  r3.x = saturate(r3.x / cb0[5].z);
  r0.z = -r1.w + r0.z;
  r0.z = r3.x * r0.z;
  r1.w = 2.75 * r0.z;
  r3.x = cmp(0.290909082 < r0.z);
  r0.z = r0.z * 2.75 + -0.800000012;
  r0.z = r0.z * 5 + 1;
  r0.z = -1 / r0.z;
  r0.z = 1 + r0.z;
  r0.z = r0.z * 0.200000003 + 0.800000012;
  r0.z = r3.x ? r0.z : r1.w;
  r0.z = 1 + -r0.z;
  r0.z = r0.z + -r1.z;
  r0.z = r0.w * r0.z + r1.z;
  r5.y = r2.w * r0.z;
  r3.xyz = hdr_enabled ? float3(0.486570895, 0.265667647, 0.198217258) : float3(0.412390918, 0.357584357, 0.180480793);
  r4.xyz = hdr_enabled ? float3(0.228974566, 0.691738427, 0.0792869031) : float3(0.212639078, 0.715168715, 0.0721923113);
  r6.xyz = hdr_enabled ? float3(0, 0.0451133773, 1.04394424) : float3(0.0193308257, 0.119194783, 0.950532138);
  r1.z = dot(r3.xyz, r2.xxx);
  r1.w = dot(r4.xyz, r2.xxx);
  r7.z = dot(r6.xyz, r2.xxx);
  r8.xy = float2(1.14999998, 0.300000012) * r1.zz;
  r7.x = -r7.z * 0.150000006 + r8.x;
  r7.y = r1.w * 0.699999988 + r8.y;
  r1.z = dot(float3(-0.201509997, 1.14217591, 0.0315739214), r7.xyz);
  r1.w = 9.99999975e-05 * abs(r1.z);
  r1.w = log2(r1.w);
  r1.w = 0.159301758 * r1.w;
  r1.w = exp2(r1.w);
  r3.w = cmp(r1.z == 0.000000);
  r5.w = cmp(0 < r1.z);
  r1.z = cmp(r1.z < 0);
  r1.z = (int)-r5.w + (int)r1.z;
  r1.z = (int)r1.z;
  r7.xy = r1.ww * float2(18.8515625, 18.6875) + float2(0.8359375, 1);
  r1.w = r7.x / r7.y;
  r1.w = log2(r1.w);
  r1.w = 134.034378 * r1.w;
  r1.w = exp2(r1.w);
  r1.z = r1.z * r1.w;
  r1.z = max(0, r1.z);
  r1.z = r3.w ? 0 : r1.z;
  r1.w = cmp(r1.z == 0.000000);
  r3.w = cmp(0 < r1.z);
  r3.w = (int)-r3.w;
  r1.z = log2(r1.z);
  r1.z = 1.08385694 * r1.z;
  r1.z = exp2(r1.z);
  r1.z = r3.w * r1.z;
  r1.z = 100 * r1.z;
  r1.z = r1.w ? 0 : r1.z;
  r7.xyz = hdr_enabled ? float3(2.49349689, -0.93138361, -0.402710766) : float3(3.24096918, -1.53738272, -0.498610646);
  r8.xyz = hdr_enabled ? float3(-0.829488993, 1.76266408, 0.0236246902) : float3(-0.969243646, 1.87596738, 0.0415550806);
  r9.xyz = hdr_enabled ? float3(0.035845831, -0.0761723891, 0.956884503) : float3(0.0556300804, -0.203976959, 1.05697155);
  r10.xy = float2(145.274094, 104.546814) * r1.xx;
  r1.w = 0.0174532942 * r2.y;
  r10.xy = exp2(r10.xy);
  r10.zw = r10.yx * r5.yx;
  r11.xy = float2(0.891250968, 0.00999999978) * r10.zw;
  r2.z = 100 * r2.z;
  r3.w = r11.x / r2.z;
  r5.w = cmp(r3.w == 0.000000);
  r6.w = cmp(0 < r3.w);
  r7.w = cmp(r3.w < 0);
  r6.w = (int)-r6.w + (int)r7.w;
  r6.w = (int)r6.w;
  r3.w = log2(abs(r3.w));
  r3.w = 1.35135138 * r3.w;
  r3.w = exp2(r3.w);
  r3.w = r6.w * r3.w;
  r3.w = r5.w ? 0 : r3.w;
  r5.w = cmp(r10.w == 0.000000);
  r6.w = cmp(0 < r10.w);
  r7.w = cmp(r10.w < 0);
  r6.w = (int)-r6.w + (int)r7.w;
  r6.w = (int)r6.w;
  r7.w = log2(abs(r11.y));
  r7.w = 0.922630966 * r7.w;
  r7.w = exp2(r7.w);
  r6.w = r7.w * r6.w;
  r11.x = r5.w ? 0 : r6.w;
  sincos(r1.w, r12.x, r13.x);
  r11.y = r13.x * r3.w;
  r11.z = r12.x * r3.w;
  r14.x = dot(float3(1, 0.277210057, 0.116094626), r11.xyz);
  r14.z = dot(float3(1, 0.0425858013, -0.753844559), r11.xyz);
  r14.y = r11.x;
  r11.xyz = log2(abs(r14.xyz));
  r11.xyz = float3(0.00746077253, 0.00746077253, 0.00746077253) * r11.xyz;
  r11.xyz = exp2(r11.xyz);
  r11.xyz = min(float3(1.00870001, 1.00870001, 1.00870001), r11.xyz);
  r12.yzw = cmp(float3(0.8359375, 0.8359375, 0.8359375) >= r11.xyz);
  r13.yzw = cmp(float3(0, 0, 0) < r14.xyz);
  r14.xyz = cmp(r14.xyz < float3(0, 0, 0));
  r13.yzw = (int3)-r13.yzw + (int3)r14.xyz;
  r13.yzw = (int3)r13.yzw;
  r14.xyz = float3(-0.8359375, -0.8359375, -0.8359375) + r11.xyz;
  r11.xyz = -r11.xyz * float3(18.6875, 18.6875, 18.6875) + float3(18.8515625, 18.8515625, 18.8515625);
  r11.xyz = r14.xyz / r11.xyz;
  r11.xyz = log2(r11.xyz);
  r11.xyz = float3(6.27739477, 6.27739477, 6.27739477) * r11.xyz;
  r11.xyz = exp2(r11.xyz);
  r11.xyz = r13.yzw * r11.xyz;
  r11.xyz = float3(10000, 10000, 10000) * r11.xyz;
  r11.xyz = r12.yzw ? float3(0, 0, 0) : r11.xyz;
  r1.w = dot(float3(1.97340584, -0.996146977, -0.025673762), r11.xyz);
  r3.w = dot(float3(0.35064584, 0.708214223, -0.0463727117), r11.xyz);
  r11.w = dot(float3(-0.0898918733, -0.305277616, 1.51366293), r11.xyz);
  r1.w = r11.w * 0.150000006 + r1.w;
  r11.x = 0.869565248 * r1.w;
  r1.w = -r1.w * 0.260869592 + r3.w;
  r11.z = 1.42857146 * r1.w;
  r14.x = dot(r7.xyz, r11.xzw);
  r14.y = dot(r8.xyz, r11.xzw);
  r14.z = dot(r9.xyz, r11.xzw);
  r11.xyz = r14.xyz / r0.xxx;
  r12.yzw = cmp(r11.xyz < float3(0, 0, 0));
  r1.w = (int)r12.z | (int)r12.y;
  r1.w = (int)r12.w | (int)r1.w;
  r3.w = min(r11.x, r11.y);
  r3.w = min(r3.w, r11.z);
  r12.yzw = r11.xyz + -r3.www;
  r11.xyz = r1.www ? r12.yzw : r11.xyz;
  r12.yzw = cmp(float3(1, 1, 1) < r11.xyz);
  r1.w = (int)r12.z | (int)r12.y;
  r1.w = (int)r12.w | (int)r1.w;
  r3.w = max(r11.x, r11.y);
  r3.w = max(r3.w, r11.z);
  r12.yzw = r11.xyz / r3.www;
  r11.xyw = r1.www ? r12.zwy : r11.yzx;
  r1.w = cmp(r11.x >= r11.y);
  r1.w = r1.w ? 1.000000 : 0;
  r14.xy = r11.yx;
  r14.zw = float2(-1, 0.666666687);
  r15.xy = -r14.xy + r11.xy;
  r15.zw = float2(1, -1);
  r14.xyzw = r1.wwww * r15.xyzw + r14.xyzw;
  r1.w = cmp(r11.w >= r14.x);
  r1.w = r1.w ? 1.000000 : 0;
  r11.xyz = r14.xyw;
  r14.xyw = r11.wyx;
  r14.xyzw = r14.xyzw + -r11.xyzw;
  r11.xyzw = r1.wwww * r14.xyzw + r11.xyzw;
  r1.w = min(r11.w, r11.y);
  r1.w = r11.x + -r1.w;
  r3.w = r11.w + -r11.y;
  r1.w = r1.w * 6 + 1.00000001e-10;
  r1.w = r3.w / r1.w;
  r1.w = r11.z + r1.w;
  r11.xyz = float3(1, 0.666666687, 0.333333343) + abs(r1.www);
  r11.xyz = frac(r11.xyz);
  r11.xyz = r11.xyz * float3(6, 6, 6) + float3(-3, -3, -3);
  r11.xyz = saturate(float3(-1, -1, -1) + abs(r11.xyz));

  // peak
  r11.xyz = r11.xyz * r2.xxx;

  r3.w = dot(r3.xyz, r11.xyz);
  r7.w = dot(r4.xyz, r11.xyz);
  r11.z = dot(r6.xyz, r11.xyz);
  r10.zw = float2(1.14999998, 0.300000012) * r3.ww;
  r11.x = -r11.z * 0.150000006 + r10.z;
  r11.y = r7.w * 0.699999988 + r10.w;
  r14.x = dot(float3(0.404802799, 0.57999903, 0.0246349014), r11.xyz);
  r14.y = dot(float3(-0.201509997, 1.14217591, 0.0315739214), r11.xyz);
  r14.z = dot(float3(-0.0166008007, 0.264800012, 0.668479919), r11.xyz);
  r11.xyz = float3(9.99999975e-05, 9.99999975e-05, 9.99999975e-05) * abs(r14.xyz);
  r11.xyz = log2(r11.xyz);
  r11.xyz = float3(0.159301758, 0.159301758, 0.159301758) * r11.xyz;
  r11.xyz = exp2(r11.xyz);
  r12.yzw = cmp(r14.xyz == float3(0, 0, 0));
  r13.yzw = cmp(float3(0, 0, 0) < r14.xyz);
  r14.xyz = cmp(r14.xyz < float3(0, 0, 0));
  r13.yzw = (int3)-r13.yzw + (int3)r14.xyz;
  r13.yzw = (int3)r13.yzw;
  r14.xyz = r11.xyz * float3(18.8515625, 18.8515625, 18.8515625) + float3(0.8359375, 0.8359375, 0.8359375);
  r11.xyz = r11.xyz * float3(18.6875, 18.6875, 18.6875) + float3(1, 1, 1);
  r11.xyz = r14.xyz / r11.xyz;
  r11.xyz = log2(r11.xyz);
  r11.xyz = float3(134.034378, 134.034378, 134.034378) * r11.xyz;
  r11.xyz = exp2(r11.xyz);
  r11.xyz = r13.yzw * r11.xyz;
  r11.xyz = r12.yzw ? float3(0, 0, 0) : r11.xyz;
  r14.x = dot(float3(3.52399993, -4.06670809, 0.54270798), r11.xyz);
  r14.y = dot(float3(0.199075997, 1.09679902, -1.29587495), r11.xyz);
  r3.w = max(0, r11.y);
  r10.zw = cmp(r14.xy == float2(0, 0));
  r7.w = r10.w ? r10.z : 0;
  r8.w = min(abs(r14.y), abs(r14.x));
  r9.w = max(abs(r14.y), abs(r14.x));
  r9.w = 1 / r9.w;
  r8.w = r9.w * r8.w;
  r9.w = r8.w * r8.w;
  r10.z = r9.w * 0.0208350997 + -0.0851330012;
  r10.z = r9.w * r10.z + 0.180141002;
  r10.z = r9.w * r10.z + -0.330299497;
  r9.w = r9.w * r10.z + 0.999866009;
  r10.z = r9.w * r8.w;
  r10.w = cmp(abs(r14.x) < abs(r14.y));
  r10.z = r10.z * -2 + 1.57079637;
  r10.z = r10.w ? r10.z : 0;
  r8.w = r8.w * r9.w + r10.z;
  r9.w = cmp(r14.x < -r14.x);
  r9.w = r9.w ? -3.141593 : 0;
  r8.w = r9.w + r8.w;
  r9.w = min(r14.y, r14.x);
  r10.z = max(r14.y, r14.x);
  r9.w = cmp(r9.w < -r9.w);
  r10.z = cmp(r10.z >= -r10.z);
  r9.w = r9.w ? r10.z : 0;
  r8.w = r9.w ? -r8.w : r8.w;
  r8.w = r8.w * 57.2957764 + 360;
  r8.w = 0.00277777785 * r8.w;
  r9.w = cmp(r8.w >= -r8.w);
  r8.w = frac(r8.w);
  r8.w = r9.w ? r8.w : -r8.w;
  r8.w = 360 * r8.w;
  r7.w = r7.w ? 0 : r8.w;
  r8.w = 89.038002 + r7.w;
  r8.w = 0.0174532942 * r8.w;
  r8.w = cos(r8.w);
  r8.w = 1.01499999 + r8.w;
  r9.w = cmp(r3.w == 0.000000);
  r10.z = cmp(0 < r3.w);
  r10.z = (int)-r10.z;
  r3.w = log2(r3.w);
  r3.w = 1.08385694 * r3.w;
  r3.w = exp2(r3.w);
  r3.w = r10.z * r3.w;
  r3.w = 100 * r3.w;
  r3.w = r9.w ? 0 : r3.w;
  r10.z = r3.w / r10.x;
  r3.w = dot(r14.xy, r14.xy);
  r3.w = log2(r3.w);
  r3.w = 0.370000005 * r3.w;
  r3.w = exp2(r3.w);
  r3.w = 100 * r3.w;
  r8.w = log2(r8.w);
  r8.w = 0.0680000037 * r8.w;
  r8.w = exp2(r8.w);
  r8.w = r8.w * r1.y;
  r9.w = 0.891250968 * r10.y;
  r8.w = r8.w / r9.w;
  r10.w = r8.w * r3.w;
  r3.w = cmp(r2.y == r7.w);
  if (r3.w == 0) {
    r3.w = cmp(r7.w < r2.y);
    r11.xy = r3.ww ? float2(1, 0.00277777785) : float2(-1, -0.00277777785);
    r11.zw = float2(0, 0);
    r14.xy = r10.zw;
    r3.w = abs(r1.w);
    r14.z = r7.w;
    r8.w = 0;
    r12.y = 0;
    while (true) {
      r12.z = cmp((int)r8.w >= 360);
      r12.y = 0;
      if (r12.z != 0) break;
      r3.w = r3.w + r11.y;
      r13.yzw = float3(1, 0.666666687, 0.333333343) + r3.www;
      r13.yzw = frac(r13.yzw);
      r13.yzw = r13.yzw * float3(6, 6, 6) + float3(-3, -3, -3);
      r13.yzw = saturate(float3(-1, -1, -1) + abs(r13.yzw));

      // peak
      r13.yzw = r13.yzw * r2.xxx;

      r12.z = dot(r3.xyz, r13.yzw);
      r12.w = dot(r4.xyz, r13.yzw);
      r15.z = dot(r6.xyz, r13.yzw);
      r13.yz = float2(1.14999998, 0.300000012) * r12.zz;
      r15.x = -r15.z * 0.150000006 + r13.y;
      r15.y = r12.w * 0.699999988 + r13.z;
      r16.x = dot(float3(0.404802799, 0.57999903, 0.0246349014), r15.xyz);
      r16.y = dot(float3(-0.201509997, 1.14217591, 0.0315739214), r15.xyz);
      r16.z = dot(float3(-0.0166008007, 0.264800012, 0.668479919), r15.xyz);
      r13.yzw = float3(9.99999975e-05, 9.99999975e-05, 9.99999975e-05) * abs(r16.xyz);
      r13.yzw = log2(r13.yzw);
      r13.yzw = float3(0.159301758, 0.159301758, 0.159301758) * r13.yzw;
      r13.yzw = exp2(r13.yzw);
      r15.xyz = cmp(r16.xyz == float3(0, 0, 0));
      r17.xyz = cmp(float3(0, 0, 0) < r16.xyz);
      r16.xyz = cmp(r16.xyz < float3(0, 0, 0));
      r16.xyz = (int3)-r17.xyz + (int3)r16.xyz;
      r16.xyz = (int3)r16.xyz;
      r17.xyz = r13.yzw * float3(18.8515625, 18.8515625, 18.8515625) + float3(0.8359375, 0.8359375, 0.8359375);
      r13.yzw = r13.yzw * float3(18.6875, 18.6875, 18.6875) + float3(1, 1, 1);
      r13.yzw = r17.xyz / r13.yzw;
      r13.yzw = log2(r13.yzw);
      r13.yzw = float3(134.034378, 134.034378, 134.034378) * r13.yzw;
      r13.yzw = exp2(r13.yzw);
      r13.yzw = r16.xyz * r13.yzw;
      r13.yzw = r15.xyz ? float3(0, 0, 0) : r13.yzw;
      r15.x = dot(float3(3.52399993, -4.06670809, 0.54270798), r13.yzw);
      r15.y = dot(float3(0.199075997, 1.09679902, -1.29587495), r13.yzw);
      r12.z = max(0, r13.z);
      r13.yz = cmp(r15.xy == float2(0, 0));
      r12.w = r13.z ? r13.y : 0;
      r13.y = min(abs(r15.y), abs(r15.x));
      r13.z = max(abs(r15.y), abs(r15.x));
      r13.z = 1 / r13.z;
      r13.y = r13.y * r13.z;
      r13.z = r13.y * r13.y;
      r13.w = r13.z * 0.0208350997 + -0.0851330012;
      r13.w = r13.z * r13.w + 0.180141002;
      r13.w = r13.z * r13.w + -0.330299497;
      r13.z = r13.z * r13.w + 0.999866009;
      r13.w = r13.y * r13.z;
      r14.w = cmp(abs(r15.x) < abs(r15.y));
      r13.w = r13.w * -2 + 1.57079637;
      r13.w = r14.w ? r13.w : 0;
      r13.y = r13.y * r13.z + r13.w;
      r13.z = cmp(r15.x < -r15.x);
      r13.z = r13.z ? -3.141593 : 0;
      r13.y = r13.y + r13.z;
      r13.z = min(r15.y, r15.x);
      r13.w = max(r15.y, r15.x);
      r13.z = cmp(r13.z < -r13.z);
      r13.w = cmp(r13.w >= -r13.w);
      r13.z = r13.w ? r13.z : 0;
      r13.y = r13.z ? -r13.y : r13.y;
      r13.y = r13.y * 57.2957764 + 360;
      r13.y = 0.00277777785 * r13.y;
      r13.z = cmp(r13.y >= -r13.y);
      r13.y = frac(r13.y);
      r13.y = r13.z ? r13.y : -r13.y;
      r13.y = 360 * r13.y;
      r16.z = r12.w ? 0 : r13.y;
      r12.w = 89.038002 + r16.z;
      r12.w = 0.0174532942 * r12.w;
      r12.w = cos(r12.w);
      r12.w = 1.01499999 + r12.w;
      r13.y = cmp(r12.z == 0.000000);
      r13.z = cmp(0 < r12.z);
      r13.z = (int)-r13.z;
      r12.z = log2(r12.z);
      r12.z = 1.08385694 * r12.z;
      r12.z = exp2(r12.z);
      r12.z = r13.z * r12.z;
      r12.z = 100 * r12.z;
      r12.z = r13.y ? 0 : r12.z;
      r16.x = r12.z / r10.x;
      r12.z = dot(r15.xy, r15.xy);
      r12.z = log2(r12.z);
      r12.z = 0.370000005 * r12.z;
      r12.z = exp2(r12.z);
      r12.w = log2(r12.w);
      r12.zw = float2(100, 0.0680000037) * r12.zw;
      r12.w = exp2(r12.w);
      r12.w = r12.w * r1.y;
      r12.w = r12.w / r9.w;
      r16.y = r12.z * r12.w;
      r12.z = cmp(r2.y == r16.z);
      r12.w = cmp(r16.z < r2.y);
      r12.w = r12.w ? 1 : -1;
      r12.z = r12.z ? 0 : r12.w;
      r12.z = cmp(r11.x != r12.z);
      r12.w = cmp(r3.w < 0);
      r12.z = (int)r12.w | (int)r12.z;
      r12.w = cmp(1 < r3.w);
      r12.z = (int)r12.w | (int)r12.z;
      if (r12.z != 0) {
        r12.w = cmp(r16.z >= r14.z);
        r15.x = (int)r12.w ? r16.x : r14.x;
        r17.x = (int)r12.w ? r14.x : r16.x;
        r15.y = (int)r12.w ? r16.y : r14.y;
        r17.y = (int)r12.w ? r14.y : r16.y;
        r15.z = (int)r12.w ? r16.z : r14.z;
        r17.z = (int)r12.w ? r14.z : r16.z;
        r12.w = -r17.z + r2.y;
        r13.yzw = -r17.zxy + r15.zxy;
        r12.w = saturate(r12.w / r13.y);
        r11.zw = r12.ww * r13.zw + r17.xy;
        r12.y = -1;
        break;
      }
      r14.xyz = r16.xyz;
      r8.w = (int)r8.w + 1;
      r12.y = r12.z;
      r11.zw = float2(0, 0);
    }
    r10.zw = r12.yy ? r11.zw : r14.xy;
  }
  r11.xyz = float3(0.929665565, 0.985136747, 1.0890578) * cb0[5].zzz;
  r1.w = dot(float3(-0.201509997, 1.14217591, 0.0315739214), r11.xyz);
  r2.y = 9.99999975e-05 * abs(r1.w);
  r2.y = log2(r2.y);
  r2.y = 0.159301758 * r2.y;
  r2.y = exp2(r2.y);
  r3.w = cmp(r1.w == 0.000000);
  r7.w = cmp(0 < r1.w);
  r1.w = cmp(r1.w < 0);
  r1.w = (int)-r7.w + (int)r1.w;
  r1.w = (int)r1.w;
  r11.xy = r2.yy * float2(18.8515625, 18.6875) + float2(0.8359375, 1);
  r2.y = r11.x / r11.y;
  r2.y = log2(r2.y);
  r2.y = 134.034378 * r2.y;
  r2.y = exp2(r2.y);
  r1.w = r2.y * r1.w;
  r1.w = max(0, r1.w);
  r1.w = r3.w ? 0 : r1.w;
  r2.y = cmp(r1.w == 0.000000);
  r3.w = cmp(0 < r1.w);
  r3.w = (int)-r3.w;
  r1.w = log2(r1.w);
  r1.w = 1.08385694 * r1.w;
  r1.w = exp2(r1.w);
  r1.w = r3.w * r1.w;
  r1.w = 100 * r1.w;
  r1.w = r2.y ? 0 : r1.w;
  r1.zw = r1.zw / r4.ww;
  r1.w = r1.w + -r10.z;
  r11.x = r1.w * 0.5 + r10.z;
  r1.w = cmp(r11.x < r5.x);
  r2.y = -r11.x + r1.z;
  r3.w = min(r1.z, r5.x);
  r3.w = -r3.w + r1.z;
  r3.w = max(9.99999975e-05, r3.w);
  r2.y = r2.y / r3.w;
  r3.w = max(9.99999975e-05, r5.x);
  r3.w = r11.x / r3.w;
  r1.w = r1.w ? r2.y : r3.w;
  r1.w = -r10.w * r1.w;
  r11.y = 0.5 * r1.w;
  r1.w = -r11.x + r5.x;
  r0.z = r2.w * r0.z + -r11.y;
  r0.z = r1.w / r0.z;
  r14.x = -r0.z * r11.y + r11.x;
  r0.z = cmp(0 >= r14.x);
  r1.w = cmp(r14.x >= r1.z);
  r0.z = (int)r0.z | (int)r1.w;
  r14.y = 0;
  r2.yw = cmp(r11.xy == r14.xy);
  r1.w = r2.w ? r2.y : 0;
  r0.z = (int)r0.z | (int)r1.w;
  if (r0.z != 0) {
    r2.yw = r14.xy;
  } else {
    // peak
    r12.yzw = r3.xyz * r2.xxx;
    r13.yzw = r4.xyz * r2.xxx;
    r15.xyz = r6.xyz * r2.xxx;

    r16.xyz = float3(0.150000006, 0.150000006, 0.150000006) * r15.xyz;
    r17.xy = r12.yz * float2(1.14999998, 1.14999998) + -r16.xy;
    r13.yzw = float3(0.699999988, 0.699999988, 0.699999988) * r13.yzw;
    r18.xy = r12.yz * float2(0.300000012, 0.300000012) + r13.yz;
    r17.z = r18.x;
    r17.w = r15.x;
    r19.x = dot(float3(0.404802799, 0.57999903, 0.0246349014), r17.xzw);
    r19.y = dot(float3(-0.201509997, 1.14217591, 0.0315739214), r17.xzw);
    r19.z = dot(float3(-0.0166008007, 0.264800012, 0.668479919), r17.xzw);
    r16.xyw = float3(9.99999975e-05, 9.99999975e-05, 9.99999975e-05) * abs(r19.xyz);
    r16.xyw = log2(r16.xyw);
    r16.xyw = float3(0.159301758, 0.159301758, 0.159301758) * r16.xyw;
    r16.xyw = exp2(r16.xyw);
    r17.xzw = cmp(r19.xyz == float3(0, 0, 0));
    r20.xyz = cmp(float3(0, 0, 0) < r19.xyz);
    r19.xyz = cmp(r19.xyz < float3(0, 0, 0));
    r19.xyz = (int3)-r20.xyz + (int3)r19.xyz;
    r19.xyz = (int3)r19.xyz;
    r20.xyz = r16.xyw * float3(18.8515625, 18.8515625, 18.8515625) + float3(0.8359375, 0.8359375, 0.8359375);
    r16.xyw = r16.xyw * float3(18.6875, 18.6875, 18.6875) + float3(1, 1, 1);
    r16.xyw = r20.xyz / r16.xyw;
    r16.xyw = log2(r16.xyw);
    r16.xyw = float3(134.034378, 134.034378, 134.034378) * r16.xyw;
    r16.xyw = exp2(r16.xyw);
    r16.xyw = r19.xyz * r16.xyw;
    r16.xyw = r17.xzw ? float3(0, 0, 0) : r16.xyw;
    r19.x = dot(float3(3.52399993, -4.06670809, 0.54270798), r16.xyw);
    r19.y = dot(float3(0.199075997, 1.09679902, -1.29587495), r16.xyw);
    r11.zw = cmp(r19.xy == float2(0, 0));
    r0.z = r11.w ? r11.z : 0;
    r1.w = min(abs(r19.y), abs(r19.x));
    r3.w = max(abs(r19.y), abs(r19.x));
    r3.w = 1 / r3.w;
    r1.w = r3.w * r1.w;
    r3.w = r1.w * r1.w;
    r4.w = r3.w * 0.0208350997 + -0.0851330012;
    r4.w = r3.w * r4.w + 0.180141002;
    r4.w = r3.w * r4.w + -0.330299497;
    r3.w = r3.w * r4.w + 0.999866009;
    r4.w = r3.w * r1.w;
    r7.w = cmp(abs(r19.x) < abs(r19.y));
    r4.w = r4.w * -2 + 1.57079637;
    r4.w = r7.w ? r4.w : 0;
    r1.w = r1.w * r3.w + r4.w;
    r3.w = cmp(r19.x < -r19.x);
    r3.w = r3.w ? -3.141593 : 0;
    r1.w = r3.w + r1.w;
    r3.w = min(r19.y, r19.x);
    r4.w = max(r19.y, r19.x);
    r3.w = cmp(r3.w < -r3.w);
    r4.w = cmp(r4.w >= -r4.w);
    r3.w = r3.w ? r4.w : 0;
    r1.w = r3.w ? -r1.w : r1.w;
    r1.w = r1.w * 57.2957764 + 360;
    r1.w = 0.00277777785 * r1.w;
    r3.w = cmp(r1.w >= -r1.w);
    r1.w = frac(r1.w);
    r1.w = r3.w ? r1.w : -r1.w;
    r1.w = r1.w * 360 + 89.038002;
    r1.w = 0.0174532942 * r1.w;
    r1.w = cos(r1.w);
    r1.w = 1.01499999 + r1.w;
    r3.w = dot(r19.xy, r19.xy);
    r3.w = log2(r3.w);
    r3.w = 0.370000005 * r3.w;
    r3.w = exp2(r3.w);
    r3.w = 100 * r3.w;
    r1.w = log2(r1.w);
    r1.w = 0.0680000037 * r1.w;
    r1.w = exp2(r1.w);
    r0.z = r0.z ? 1.00213027 : r1.w;
    r0.z = r0.z * r1.y;
    r16.xyw = float3(104.546814, 104.546814, 145.274094) * r1.xxx;
    r16.xyw = exp2(r16.xyw);
    r1.x = 0.891250968 * r16.x;
    r0.z = r0.z / r1.x;
    r0.z = r3.w * r0.z;

    // peak
    r1.w = dot(r3.xy, r2.xx);
    r3.w = dot(r4.xy, r2.xx);
    r19.z = dot(r6.xy, r2.xx);
    r11.zw = float2(1.14999998, 0.300000012) * r1.ww;
    r19.x = -r19.z * 0.150000006 + r11.z;
    r19.y = r3.w * 0.699999988 + r11.w;
    r20.x = dot(float3(0.404802799, 0.57999903, 0.0246349014), r19.xyz);
    r20.y = dot(float3(-0.201509997, 1.14217591, 0.0315739214), r19.xyz);
    r20.z = dot(float3(-0.0166008007, 0.264800012, 0.668479919), r19.xyz);
    r17.xzw = float3(9.99999975e-05, 9.99999975e-05, 9.99999975e-05) * abs(r20.xyz);
    r17.xzw = log2(r17.xzw);
    r17.xzw = float3(0.159301758, 0.159301758, 0.159301758) * r17.xzw;
    r17.xzw = exp2(r17.xzw);
    r19.xyz = cmp(r20.xyz == float3(0, 0, 0));
    r21.xyz = cmp(float3(0, 0, 0) < r20.xyz);
    r20.xyz = cmp(r20.xyz < float3(0, 0, 0));
    r20.xyz = (int3)-r21.xyz + (int3)r20.xyz;
    r20.xyz = (int3)r20.xyz;
    r21.xyz = r17.xzw * float3(18.8515625, 18.8515625, 18.8515625) + float3(0.8359375, 0.8359375, 0.8359375);
    r17.xzw = r17.xzw * float3(18.6875, 18.6875, 18.6875) + float3(1, 1, 1);
    r17.xzw = r21.xyz / r17.xzw;
    r17.xzw = log2(r17.xzw);
    r17.xzw = float3(134.034378, 134.034378, 134.034378) * r17.xzw;
    r17.xzw = exp2(r17.xzw);
    r17.xzw = r20.xyz * r17.xzw;
    r17.xzw = r19.xyz ? float3(0, 0, 0) : r17.xzw;
    r19.x = dot(float3(3.52399993, -4.06670809, 0.54270798), r17.xzw);
    r19.y = dot(float3(0.199075997, 1.09679902, -1.29587495), r17.xzw);
    r11.zw = cmp(r19.xy == float2(0, 0));
    r1.w = r11.w ? r11.z : 0;
    r3.w = min(abs(r19.y), abs(r19.x));
    r4.w = max(abs(r19.y), abs(r19.x));
    r4.w = 1 / r4.w;
    r3.w = r4.w * r3.w;
    r4.w = r3.w * r3.w;
    r7.w = r4.w * 0.0208350997 + -0.0851330012;
    r7.w = r4.w * r7.w + 0.180141002;
    r7.w = r4.w * r7.w + -0.330299497;
    r4.w = r4.w * r7.w + 0.999866009;
    r7.w = r4.w * r3.w;
    r8.w = cmp(abs(r19.x) < abs(r19.y));
    r7.w = r7.w * -2 + 1.57079637;
    r7.w = r8.w ? r7.w : 0;
    r3.w = r3.w * r4.w + r7.w;
    r4.w = cmp(r19.x < -r19.x);
    r4.w = r4.w ? -3.141593 : 0;
    r3.w = r4.w + r3.w;
    r4.w = min(r19.y, r19.x);
    r7.w = max(r19.y, r19.x);
    r4.w = cmp(r4.w < -r4.w);
    r7.w = cmp(r7.w >= -r7.w);
    r4.w = r4.w ? r7.w : 0;
    r3.w = r4.w ? -r3.w : r3.w;
    r3.w = r3.w * 57.2957764 + 360;
    r3.w = 0.00277777785 * r3.w;
    r4.w = cmp(r3.w >= -r3.w);
    r3.w = frac(r3.w);
    r3.w = r4.w ? r3.w : -r3.w;
    r3.w = r3.w * 360 + 89.038002;
    r3.w = 0.0174532942 * r3.w;
    r3.w = cos(r3.w);
    r3.w = 1.01499999 + r3.w;
    r4.w = dot(r19.xy, r19.xy);
    r4.w = log2(r4.w);
    r4.w = 0.370000005 * r4.w;
    r4.w = exp2(r4.w);
    r4.w = 100 * r4.w;
    r3.w = log2(r3.w);
    r3.w = 0.0680000037 * r3.w;
    r3.w = exp2(r3.w);
    r1.w = r1.w ? 1.00213027 : r3.w;
    r1.w = r1.w * r1.y;
    r1.w = r1.w / r1.x;
    r1.w = r4.w * r1.w;
    r0.z = max(r1.w, r0.z);
    r18.z = r17.y;
    r18.w = r15.y;
    r17.x = dot(float3(0.57999903, 0.404802799, 0.0246349014), r18.yzw);
    r17.y = dot(float3(1.14217591, -0.201509997, 0.0315739214), r18.yzw);
    r17.z = dot(float3(0.264800012, -0.0166008007, 0.668479919), r18.yzw);
    r18.xyz = float3(9.99999975e-05, 9.99999975e-05, 9.99999975e-05) * abs(r17.xyz);
    r18.xyz = log2(r18.xyz);
    r18.xyz = float3(0.159301758, 0.159301758, 0.159301758) * r18.xyz;
    r18.xyz = exp2(r18.xyz);
    r19.xyz = cmp(r17.xyz == float3(0, 0, 0));
    r20.xyz = cmp(float3(0, 0, 0) < r17.xyz);
    r17.xyz = cmp(r17.xyz < float3(0, 0, 0));
    r17.xyz = (int3)-r20.xyz + (int3)r17.xyz;
    r17.xyz = (int3)r17.xyz;
    r20.xyz = r18.xyz * float3(18.8515625, 18.8515625, 18.8515625) + float3(0.8359375, 0.8359375, 0.8359375);
    r18.xyz = r18.xyz * float3(18.6875, 18.6875, 18.6875) + float3(1, 1, 1);
    r18.xyz = r20.xyz / r18.xyz;
    r18.xyz = log2(r18.xyz);
    r18.xyz = float3(134.034378, 134.034378, 134.034378) * r18.xyz;
    r18.xyz = exp2(r18.xyz);
    r17.xyz = r18.xyz * r17.xyz;
    r17.xyz = r19.xyz ? float3(0, 0, 0) : r17.xyz;
    r18.x = dot(float3(3.52399993, -4.06670809, 0.54270798), r17.xyz);
    r18.y = dot(float3(0.199075997, 1.09679902, -1.29587495), r17.xyz);
    r11.zw = cmp(r18.xy == float2(0, 0));
    r1.w = r11.w ? r11.z : 0;
    r3.w = min(abs(r18.y), abs(r18.x));
    r4.w = max(abs(r18.y), abs(r18.x));
    r4.w = 1 / r4.w;
    r3.w = r4.w * r3.w;
    r4.w = r3.w * r3.w;
    r7.w = r4.w * 0.0208350997 + -0.0851330012;
    r7.w = r4.w * r7.w + 0.180141002;
    r7.w = r4.w * r7.w + -0.330299497;
    r4.w = r4.w * r7.w + 0.999866009;
    r7.w = r4.w * r3.w;
    r8.w = cmp(abs(r18.x) < abs(r18.y));
    r7.w = r7.w * -2 + 1.57079637;
    r7.w = r8.w ? r7.w : 0;
    r3.w = r3.w * r4.w + r7.w;
    r4.w = cmp(r18.x < -r18.x);
    r4.w = r4.w ? -3.141593 : 0;
    r3.w = r4.w + r3.w;
    r4.w = min(r18.y, r18.x);
    r7.w = max(r18.y, r18.x);
    r4.w = cmp(r4.w < -r4.w);
    r7.w = cmp(r7.w >= -r7.w);
    r4.w = r4.w ? r7.w : 0;
    r3.w = r4.w ? -r3.w : r3.w;
    r3.w = r3.w * 57.2957764 + 360;
    r3.w = 0.00277777785 * r3.w;
    r4.w = cmp(r3.w >= -r3.w);
    r3.w = frac(r3.w);
    r3.w = r4.w ? r3.w : -r3.w;
    r3.w = r3.w * 360 + 89.038002;
    r3.w = 0.0174532942 * r3.w;
    r3.w = cos(r3.w);
    r3.w = 1.01499999 + r3.w;
    r4.w = dot(r18.xy, r18.xy);
    r4.w = log2(r4.w);
    r4.w = 0.370000005 * r4.w;
    r4.w = exp2(r4.w);
    r4.w = 100 * r4.w;
    r3.w = log2(r3.w);
    r3.w = 0.0680000037 * r3.w;
    r3.w = exp2(r3.w);
    r1.w = r1.w ? 1.00213027 : r3.w;
    r1.w = r1.w * r1.y;
    r1.w = r1.w / r1.x;
    r1.w = r4.w * r1.w;
    r0.z = max(r1.w, r0.z);

    // peak
    r1.w = dot(r3.yz, r2.xx);
    r3.y = dot(r4.yz, r2.xx);
    r17.z = dot(r6.yz, r2.xx);
    r4.yw = float2(1.14999998, 0.300000012) * r1.ww;
    r17.x = -r17.z * 0.150000006 + r4.y;
    r17.y = r3.y * 0.699999988 + r4.w;
    r18.x = dot(float3(0.404802799, 0.57999903, 0.0246349014), r17.xyz);
    r18.y = dot(float3(-0.201509997, 1.14217591, 0.0315739214), r17.xyz);
    r18.z = dot(float3(-0.0166008007, 0.264800012, 0.668479919), r17.xyz);
    r17.xyz = float3(9.99999975e-05, 9.99999975e-05, 9.99999975e-05) * abs(r18.xyz);
    r17.xyz = log2(r17.xyz);
    r17.xyz = float3(0.159301758, 0.159301758, 0.159301758) * r17.xyz;
    r17.xyz = exp2(r17.xyz);
    r19.xyz = cmp(r18.xyz == float3(0, 0, 0));
    r20.xyz = cmp(float3(0, 0, 0) < r18.xyz);
    r18.xyz = cmp(r18.xyz < float3(0, 0, 0));
    r18.xyz = (int3)-r20.xyz + (int3)r18.xyz;
    r18.xyz = (int3)r18.xyz;
    r20.xyz = r17.xyz * float3(18.8515625, 18.8515625, 18.8515625) + float3(0.8359375, 0.8359375, 0.8359375);
    r17.xyz = r17.xyz * float3(18.6875, 18.6875, 18.6875) + float3(1, 1, 1);
    r17.xyz = r20.xyz / r17.xyz;
    r17.xyz = log2(r17.xyz);
    r17.xyz = float3(134.034378, 134.034378, 134.034378) * r17.xyz;
    r17.xyz = exp2(r17.xyz);
    r17.xyz = r18.xyz * r17.xyz;
    r17.xyz = r19.xyz ? float3(0, 0, 0) : r17.xyz;
    r18.x = dot(float3(3.52399993, -4.06670809, 0.54270798), r17.xyz);
    r18.y = dot(float3(0.199075997, 1.09679902, -1.29587495), r17.xyz);
    r3.yw = cmp(r18.xy == float2(0, 0));
    r1.w = r3.w ? r3.y : 0;
    r3.y = min(abs(r18.y), abs(r18.x));
    r3.w = max(abs(r18.y), abs(r18.x));
    r3.w = 1 / r3.w;
    r3.y = r3.y * r3.w;
    r3.w = r3.y * r3.y;
    r4.y = r3.w * 0.0208350997 + -0.0851330012;
    r4.y = r3.w * r4.y + 0.180141002;
    r4.y = r3.w * r4.y + -0.330299497;
    r3.w = r3.w * r4.y + 0.999866009;
    r4.y = r3.y * r3.w;
    r4.w = cmp(abs(r18.x) < abs(r18.y));
    r4.y = r4.y * -2 + 1.57079637;
    r4.y = r4.w ? r4.y : 0;
    r3.y = r3.y * r3.w + r4.y;
    r3.w = cmp(r18.x < -r18.x);
    r3.w = r3.w ? -3.141593 : 0;
    r3.y = r3.y + r3.w;
    r3.w = min(r18.y, r18.x);
    r4.y = max(r18.y, r18.x);
    r3.w = cmp(r3.w < -r3.w);
    r4.y = cmp(r4.y >= -r4.y);
    r3.w = r3.w ? r4.y : 0;
    r3.y = r3.w ? -r3.y : r3.y;
    r3.y = r3.y * 57.2957764 + 360;
    r3.y = 0.00277777785 * r3.y;
    r3.w = cmp(r3.y >= -r3.y);
    r3.y = frac(r3.y);
    r3.y = r3.w ? r3.y : -r3.y;
    r3.y = r3.y * 360 + 89.038002;
    r3.y = 0.0174532942 * r3.y;
    r3.y = cos(r3.y);
    r3.y = 1.01499999 + r3.y;
    r3.w = dot(r18.xy, r18.xy);
    r3.w = log2(r3.w);
    r3.w = 0.370000005 * r3.w;
    r3.w = exp2(r3.w);
    r3.y = log2(r3.y);
    r3.yw = float2(0.0680000037, 100) * r3.yw;
    r3.y = exp2(r3.y);
    r1.w = r1.w ? 1.00213027 : r3.y;
    r1.w = r1.w * r1.y;
    r1.w = r1.w / r1.x;
    r1.w = r3.w * r1.w;
    r0.z = max(r1.w, r0.z);
    r15.x = r12.w * 1.14999998 + -r16.z;
    r15.y = r12.w * 0.300000012 + r13.w;
    r17.x = dot(float3(0.404802799, 0.57999903, 0.0246349014), r15.xyz);
    r17.y = dot(float3(-0.201509997, 1.14217591, 0.0315739214), r15.xyz);
    r17.z = dot(float3(-0.0166008007, 0.264800012, 0.668479919), r15.xyz);
    r12.yzw = float3(9.99999975e-05, 9.99999975e-05, 9.99999975e-05) * abs(r17.xyz);
    r12.yzw = log2(r12.yzw);
    r12.yzw = float3(0.159301758, 0.159301758, 0.159301758) * r12.yzw;
    r12.yzw = exp2(r12.yzw);
    r13.yzw = cmp(r17.xyz == float3(0, 0, 0));
    r15.xyz = cmp(float3(0, 0, 0) < r17.xyz);
    r17.xyz = cmp(r17.xyz < float3(0, 0, 0));
    r15.xyz = (int3)-r15.xyz + (int3)r17.xyz;
    r15.xyz = (int3)r15.xyz;
    r17.xyz = r12.yzw * float3(18.8515625, 18.8515625, 18.8515625) + float3(0.8359375, 0.8359375, 0.8359375);
    r12.yzw = r12.yzw * float3(18.6875, 18.6875, 18.6875) + float3(1, 1, 1);
    r12.yzw = r17.xyz / r12.yzw;
    r12.yzw = log2(r12.yzw);
    r12.yzw = float3(134.034378, 134.034378, 134.034378) * r12.yzw;
    r12.yzw = exp2(r12.yzw);
    r12.yzw = r15.xyz * r12.yzw;
    r12.yzw = r13.yzw ? float3(0, 0, 0) : r12.yzw;
    r15.x = dot(float3(3.52399993, -4.06670809, 0.54270798), r12.yzw);
    r15.y = dot(float3(0.199075997, 1.09679902, -1.29587495), r12.yzw);
    r3.yw = cmp(r15.xy == float2(0, 0));
    r1.w = r3.w ? r3.y : 0;
    r3.y = min(abs(r15.y), abs(r15.x));
    r3.w = max(abs(r15.y), abs(r15.x));
    r3.w = 1 / r3.w;
    r3.y = r3.y * r3.w;
    r3.w = r3.y * r3.y;
    r4.y = r3.w * 0.0208350997 + -0.0851330012;
    r4.y = r3.w * r4.y + 0.180141002;
    r4.y = r3.w * r4.y + -0.330299497;
    r3.w = r3.w * r4.y + 0.999866009;
    r4.y = r3.y * r3.w;
    r4.w = cmp(abs(r15.x) < abs(r15.y));
    r4.y = r4.y * -2 + 1.57079637;
    r4.y = r4.w ? r4.y : 0;
    r3.y = r3.y * r3.w + r4.y;
    r3.w = cmp(r15.x < -r15.x);
    r3.w = r3.w ? -3.141593 : 0;
    r3.y = r3.y + r3.w;
    r3.w = min(r15.y, r15.x);
    r4.y = max(r15.y, r15.x);
    r3.w = cmp(r3.w < -r3.w);
    r4.y = cmp(r4.y >= -r4.y);
    r3.w = r3.w ? r4.y : 0;
    r3.y = r3.w ? -r3.y : r3.y;
    r3.y = r3.y * 57.2957764 + 360;
    r3.y = 0.00277777785 * r3.y;
    r3.w = cmp(r3.y >= -r3.y);
    r3.y = frac(r3.y);
    r3.y = r3.w ? r3.y : -r3.y;
    r3.y = r3.y * 360 + 89.038002;
    r3.y = 0.0174532942 * r3.y;
    r3.y = cos(r3.y);
    r3.y = 1.01499999 + r3.y;
    r3.w = dot(r15.xy, r15.xy);
    r3.w = log2(r3.w);
    r3.w = 0.370000005 * r3.w;
    r3.w = exp2(r3.w);
    r3.y = log2(r3.y);
    r3.yw = float2(0.0680000037, 100) * r3.yw;
    r3.y = exp2(r3.y);
    r1.w = r1.w ? 1.00213027 : r3.y;
    r1.w = r1.w * r1.y;
    r1.w = r1.w / r1.x;
    r1.w = r3.w * r1.w;
    r0.z = max(r1.w, r0.z);

    // peak
    r1.w = dot(r3.xz, r2.xx);
    r3.x = dot(r4.xz, r2.xx);
    r4.z = dot(r6.xz, r2.xx);

    r3.yz = float2(1.14999998, 0.300000012) * r1.ww;
    r4.x = -r4.z * 0.150000006 + r3.y;
    r4.y = r3.x * 0.699999988 + r3.z;
    r3.x = dot(float3(0.404802799, 0.57999903, 0.0246349014), r4.xyz);
    r3.y = dot(float3(-0.201509997, 1.14217591, 0.0315739214), r4.xyz);
    r3.z = dot(float3(-0.0166008007, 0.264800012, 0.668479919), r4.xyz);
    r4.xyz = float3(9.99999975e-05, 9.99999975e-05, 9.99999975e-05) * abs(r3.xyz);
    r4.xyz = log2(r4.xyz);
    r4.xyz = float3(0.159301758, 0.159301758, 0.159301758) * r4.xyz;
    r4.xyz = exp2(r4.xyz);
    r6.xyz = cmp(r3.xyz == float3(0, 0, 0));
    r12.yzw = cmp(float3(0, 0, 0) < r3.xyz);
    r3.xyz = cmp(r3.xyz < float3(0, 0, 0));
    r3.xyz = (int3)-r12.yzw + (int3)r3.xyz;
    r3.xyz = (int3)r3.xyz;
    r12.yzw = r4.xyz * float3(18.8515625, 18.8515625, 18.8515625) + float3(0.8359375, 0.8359375, 0.8359375);
    r4.xyz = r4.xyz * float3(18.6875, 18.6875, 18.6875) + float3(1, 1, 1);
    r4.xyz = r12.yzw / r4.xyz;
    r4.xyz = log2(r4.xyz);
    r4.xyz = float3(134.034378, 134.034378, 134.034378) * r4.xyz;
    r4.xyz = exp2(r4.xyz);
    r3.xyz = r4.xyz * r3.xyz;
    r3.xyz = r6.xyz ? float3(0, 0, 0) : r3.xyz;
    r4.x = dot(float3(3.52399993, -4.06670809, 0.54270798), r3.xyz);
    r4.y = dot(float3(0.199075997, 1.09679902, -1.29587495), r3.xyz);
    r3.xy = cmp(r4.xy == float2(0, 0));
    r1.w = r3.y ? r3.x : 0;
    r3.x = min(abs(r4.y), abs(r4.x));
    r3.y = max(abs(r4.y), abs(r4.x));
    r3.y = 1 / r3.y;
    r3.x = r3.x * r3.y;
    r3.y = r3.x * r3.x;
    r3.z = r3.y * 0.0208350997 + -0.0851330012;
    r3.z = r3.y * r3.z + 0.180141002;
    r3.z = r3.y * r3.z + -0.330299497;
    r3.y = r3.y * r3.z + 0.999866009;
    r3.z = r3.x * r3.y;
    r3.w = cmp(abs(r4.x) < abs(r4.y));
    r3.z = r3.z * -2 + 1.57079637;
    r3.z = r3.w ? r3.z : 0;
    r3.x = r3.x * r3.y + r3.z;
    r3.y = cmp(r4.x < -r4.x);
    r3.y = r3.y ? -3.141593 : 0;
    r3.x = r3.x + r3.y;
    r3.y = min(r4.y, r4.x);
    r3.z = max(r4.y, r4.x);
    r3.y = cmp(r3.y < -r3.y);
    r3.z = cmp(r3.z >= -r3.z);
    r3.y = r3.z ? r3.y : 0;
    r3.x = r3.y ? -r3.x : r3.x;
    r3.x = r3.x * 57.2957764 + 360;
    r3.x = 0.00277777785 * r3.x;
    r3.y = cmp(r3.x >= -r3.x);
    r3.x = frac(r3.x);
    r3.x = r3.y ? r3.x : -r3.x;
    r3.x = r3.x * 360 + 89.038002;
    r3.x = 0.0174532942 * r3.x;
    r3.x = cos(r3.x);
    r3.x = 1.01499999 + r3.x;
    r3.y = dot(r4.xy, r4.xy);
    r3.y = log2(r3.y);
    r3.y = 0.370000005 * r3.y;
    r3.y = exp2(r3.y);
    r3.x = log2(r3.x);
    r3.xy = float2(0.0680000037, 100) * r3.xy;
    r3.x = exp2(r3.x);
    r1.w = r1.w ? 1.00213027 : r3.x;
    r1.y = r1.w * r1.y;
    r1.x = r1.y / r1.x;
    r1.x = r3.y * r1.x;
    r0.z = max(r1.x, r0.z);
    r1.x = cmp(r10.z < r5.x);
    r1.y = -r10.z + r5.x;
    r1.w = r1.z + -r10.z;
    r1.w = max(9.99999997e-07, r1.w);
    r1.y = saturate(r1.y / r1.w);
    r1.w = r10.z + -r5.x;
    r3.x = max(9.99999997e-07, r10.z);
    r1.w = saturate(r1.w / r3.x);
    r1.x = r1.x ? r1.y : r1.w;
    r1.y = 0.333333343 * r10.w;
    r1.w = -r10.w * 0.333333343 + 0.100000001;
    r1.x = r1.x * r1.w + r1.y;
    r1.y = r2.x / r0.x;  // peak
    r3.xy = r14.xy + -r11.xy;
    r1.w = dot(r3.xy, r3.xy);
    r1.w = rsqrt(r1.w);
    r3.xy = r3.xy * r1.ww;
    r4.x = r1.x;
    r4.y = -1;
    r3.zw = r14.xy;
    r1.w = 0;
    while (true) {
      r4.z = cmp((int)r1.w >= 10);
      if (r4.z != 0) break;
      r4.zw = r3.zw;
      r6.xy = r4.xy;
      r6.z = 0;
      while (true) {
        r7.w = cmp((int)r6.z >= 128);
        if (r7.w != 0) break;
        r10.xz = r3.xy * r6.xx + r4.zw;
        r11.xy = r10.zx * r16.yw;
        r11.xz = float2(0.891250968, 0.00999999978) * r11.xy;
        r7.w = r11.x / r2.z;
        r8.w = cmp(r7.w == 0.000000);
        r9.w = cmp(0 < r7.w);
        r10.w = cmp(r7.w < 0);
        r9.w = (int)-r9.w + (int)r10.w;
        r9.w = (int)r9.w;
        r7.w = log2(abs(r7.w));
        r7.w = 1.35135138 * r7.w;
        r7.w = exp2(r7.w);
        r7.w = r9.w * r7.w;
        r7.w = r8.w ? 0 : r7.w;
        r8.w = cmp(r11.y == 0.000000);
        r9.w = cmp(0 < r11.y);
        r10.w = cmp(r11.y < 0);
        r9.w = (int)-r9.w + (int)r10.w;
        r9.w = (int)r9.w;
        r10.w = log2(abs(r11.z));
        r10.w = 0.922630966 * r10.w;
        r10.w = exp2(r10.w);
        r9.w = r10.w * r9.w;
        r11.x = r8.w ? 0 : r9.w;
        r11.y = r7.w * r13.x;
        r11.z = r7.w * r12.x;
        r15.x = dot(float3(1, 0.277210057, 0.116094626), r11.xyz);
        r15.z = dot(float3(1, 0.0425858013, -0.753844559), r11.xyz);
        r15.y = r11.x;
        r11.xyz = log2(abs(r15.xyz));
        r11.xyz = float3(0.00746077253, 0.00746077253, 0.00746077253) * r11.xyz;
        r11.xyz = exp2(r11.xyz);
        r11.xyz = min(float3(1.00870001, 1.00870001, 1.00870001), r11.xyz);
        r12.yzw = cmp(float3(0.8359375, 0.8359375, 0.8359375) >= r11.xyz);
        r13.yzw = cmp(float3(0, 0, 0) < r15.xyz);
        r15.xyz = cmp(r15.xyz < float3(0, 0, 0));
        r13.yzw = (int3)-r13.yzw + (int3)r15.xyz;
        r13.yzw = (int3)r13.yzw;
        r15.xyz = float3(-0.8359375, -0.8359375, -0.8359375) + r11.xyz;
        r11.xyz = -r11.xyz * float3(18.6875, 18.6875, 18.6875) + float3(18.8515625, 18.8515625, 18.8515625);
        r11.xyz = r15.xyz / r11.xyz;
        r11.xyz = log2(r11.xyz);
        r11.xyz = float3(6.27739477, 6.27739477, 6.27739477) * r11.xyz;
        r11.xyz = exp2(r11.xyz);
        r11.xyz = r13.yzw * r11.xyz;
        r11.xyz = float3(10000, 10000, 10000) * r11.xyz;
        r11.xyz = r12.yzw ? float3(0, 0, 0) : r11.xyz;
        r7.w = dot(float3(1.97340584, -0.996146977, -0.025673762), r11.xyz);
        r8.w = dot(float3(0.35064584, 0.708214223, -0.0463727117), r11.xyz);
        r11.w = dot(float3(-0.0898918733, -0.305277616, 1.51366293), r11.xyz);
        r7.w = r11.w * 0.150000006 + r7.w;
        r11.x = 0.869565248 * r7.w;
        r7.w = -r7.w * 0.260869592 + r8.w;
        r11.z = 1.42857146 * r7.w;
        r11.xyz = r11.xzw / r0.xxx;
        r15.x = dot(r7.xyz, r11.xyz);
        r15.y = dot(r8.xyz, r11.xyz);
        r15.z = dot(r9.xyz, r11.xyz);
        r11.xyz = r15.xyz / r1.yyy;
        r7.w = min(r11.y, r11.z);
        r7.w = min(r11.x, r7.w);
        r8.w = max(r11.y, r11.z);
        r8.w = max(r11.x, r8.w);
        r8.w = 0.100000001 * r8.w;
        r7.w = 1 + -r7.w;
        r7.w = r8.w * r7.w;
        r7.w = max(0, r7.w);
        r7.w = min(0.100000001, r7.w);
        r8.w = 1 + -r7.w;
        r12.yzw = max(r11.xyz, r7.www);
        r12.yzw = min(r12.yzw, r8.www);
        r11.xyz = -r12.yzw + r11.xyz;
        r8.w = dot(r11.xyz, r11.xyz);
        r7.w = r7.w * r7.w;
        r7.w = cmp(r7.w >= r8.w);
        r8.w = cmp(r10.x < 0);
        r9.w = cmp(r1.z < r10.x);
        r8.w = (int)r8.w | (int)r9.w;
        r9.w = cmp(r0.z < r10.z);
        r8.w = (int)r8.w | (int)r9.w;
        r9.w = ~(int)r7.w;
        r8.w = (int)r8.w | (int)r9.w;
        r8.w = r8.w ? r6.y : 0;
        if (r8.w != 0) {
          r8.w = -0.5 * abs(r6.x);
          r4.zw = r10.xz;
          r6.y = 0;
          r6.x = r8.w;
          break;
        } else {
          r8.w = ~(int)r6.y;
          r9.w = cmp(r10.z < 0);
          r7.w = (int)r7.w | (int)r9.w;
          r7.w = r7.w ? r8.w : 0;
          if (r7.w != 0) {
            r7.w = 0.5 * abs(r6.x);
            r4.zw = r10.xz;
            r6.y = -1;
            r6.x = r7.w;
            break;
          }
        }
        r6.z = (int)r6.z + 1;
        r4.zw = r10.xz;
      }
      r3.zw = r4.zw;
      r4.xy = r6.xy;
      r1.w = (int)r1.w + 1;
    }
    r1.xy = max(float2(0, 0), r3.zw);
    r2.y = min(r1.x, r1.z);
    r2.w = min(r1.y, r0.z);
  }
  r1.xy = r2.yw + -r14.xy;
  r0.z = dot(r1.xy, r1.xy);
  r0.z = sqrt(r0.z);
  r0.z = max(9.99999975e-05, r0.z);
  r0.z = 1 / r0.z;
  r1.xy = -r14.xy + r5.xy;
  r1.z = dot(r1.xy, r1.xy);
  r1.w = sqrt(r1.z);
  r2.y = r1.w * r0.z;
  r3.xyzw = r0.yyyy ? float4(0.699999988, -0.699999988, 0.50000006, 0.300000012) : float4(0.75, -0.75, 0.450000048, 0.25);
  r0.y = r3.w / r3.z;
  r0.y = log2(r0.y);
  r0.y = -1.20000005 * r0.y;
  r0.y = exp2(r0.y);
  r0.y = -1 + r0.y;
  r0.y = log2(r0.y);
  r0.y = 0.833333313 * r0.y;
  r0.y = exp2(r0.y);
  r0.y = r3.z / r0.y;
  r2.w = cmp(r2.y < r3.x);
  r1.w = r1.w * r0.z + r3.y;
  r0.y = r1.w / r0.y;
  r0.y = log2(r0.y);
  r0.y = 1.20000005 * r0.y;
  r0.y = exp2(r0.y);
  r0.y = 1 + r0.y;
  r0.y = log2(r0.y);
  r0.y = 0.833333313 * r0.y;
  r0.y = exp2(r0.y);
  r0.y = r1.w / r0.y;
  r0.y = r3.x + r0.y;
  r0.y = r2.w ? r2.y : r0.y;
  r2.yw = cmp(r5.xy == r14.xy);
  r1.w = r2.w ? r2.y : 0;
  r1.z = rsqrt(r1.z);
  r1.xy = r1.xy * r1.zz;
  r1.xy = r1.xy * r0.yy;
  r0.yz = r1.xy / r0.zz;
  r0.yz = r14.xy + r0.yz;
  r0.yz = r1.ww ? r14.xy : r0.yz;
  if (!hdr_enabled) {
    r1.x = r5.w ? 0 : r6.w;
    r3.y = r1.x;
    r1.w = -1;
    r2.y = 0;
    while (true) {
      r2.w = cmp((int)r2.y >= 128);
      if (r2.w != 0) break;
      r2.w = (int)r2.y;
      r1.w = 1 + r2.w;
      r2.w = r1.w * r10.y;
      r2.w = 0.891250968 * r2.w;
      r2.w = r2.w / r2.z;
      r3.w = cmp(r2.w == 0.000000);
      r4.x = cmp(0 < r2.w);
      r4.y = cmp(r2.w < 0);
      r4.x = (int)-r4.x + (int)r4.y;
      r4.x = (int)r4.x;
      r2.w = log2(abs(r2.w));
      r2.w = 1.35135138 * r2.w;
      r2.w = exp2(r2.w);
      r2.w = r4.x * r2.w;
      r2.w = r3.w ? 0 : r2.w;
      r1.y = r2.w * r13.x;
      r1.z = r2.w * r12.x;
      r3.x = dot(float3(1, 0.277210057, 0.116094626), r1.xyz);
      r3.z = dot(float3(1, 0.0425858013, -0.753844559), r1.xyz);
      r4.xyz = log2(abs(r3.xyz));
      r4.xyz = float3(0.00746077253, 0.00746077253, 0.00746077253) * r4.xyz;
      r4.xyz = exp2(r4.xyz);
      r4.xyz = min(float3(1.00870001, 1.00870001, 1.00870001), r4.xyz);
      r6.xyz = cmp(float3(0.8359375, 0.8359375, 0.8359375) >= r4.xyz);
      r7.xyz = cmp(float3(0, 0, 0) < r3.xyz);
      r3.xzw = cmp(r3.xyz < float3(0, 0, 0));
      r3.xzw = (int3)-r7.xyz + (int3)r3.xzw;
      r3.xzw = (int3)r3.xzw;
      r7.xyz = float3(-0.8359375, -0.8359375, -0.8359375) + r4.xyz;
      r4.xyz = -r4.xyz * float3(18.6875, 18.6875, 18.6875) + float3(18.8515625, 18.8515625, 18.8515625);
      r4.xyz = r7.xyz / r4.xyz;
      r4.xyz = log2(r4.xyz);
      r4.xyz = float3(6.27739477, 6.27739477, 6.27739477) * r4.xyz;
      r4.xyz = exp2(r4.xyz);
      r3.xzw = r4.xyz * r3.xzw;
      r3.xzw = float3(10000, 10000, 10000) * r3.xzw;
      r3.xzw = r6.xyz ? float3(0, 0, 0) : r3.xzw;
      r1.y = dot(float3(1.97340584, -0.996146977, -0.025673762), r3.xzw);
      r1.z = dot(float3(0.35064584, 0.708214223, -0.0463727117), r3.xzw);
      r3.w = dot(float3(-0.0898918733, -0.305277616, 1.51366293), r3.xzw);
      r1.y = r3.w * 0.150000006 + r1.y;
      r3.x = 0.869565248 * r1.y;
      r1.y = -r1.y * 0.260869592 + r1.z;
      r3.z = 1.42857146 * r1.y;
      r4.x = dot(float3(3.24096918, -1.53738272, -0.498610646), r3.xzw);
      r4.y = dot(float3(-0.969243646, 1.87596738, 0.0415550806), r3.xzw);
      r4.z = dot(float3(0.0556300804, -0.203976959, 1.05697155), r3.xzw);
      r3.xzw = cmp(r4.xyz < float3(0, 0, 0));
      r1.y = (int)r3.z | (int)r3.x;
      r1.y = (int)r3.w | (int)r1.y;
      if (r1.y != 0) {
        break;
      }
      r2.y = (int)r2.y + 1;
      r1.w = -1;
    }
    r1.x = max(0, r1.w);
    r1.y = cmp(2 < r1.x);
    r1.z = r1.x * r1.x;
    r1.z = r1.z * 0.25 + 1;
    r1.x = r1.y ? r1.x : r1.z;
    r1.y = cmp(r5.y >= 9.99999997e-07);
    r1.z = r5.y / r1.x;
    r1.w = cmp(r1.z < 0.680000007);
    r2.y = -0.680000007 + r1.z;
    r2.w = 1.78631067 * r2.y;
    r2.w = log2(r2.w);
    r2.w = 1.07500005 * r2.w;
    r2.w = exp2(r2.w);
    r2.w = 1 + r2.w;
    r2.w = log2(r2.w);
    r2.w = 0.930232525 * r2.w;
    r2.w = exp2(r2.w);
    r2.y = r2.y / r2.w;
    r2.y = 0.680000007 + r2.y;
    r1.z = r1.w ? r1.z : r2.y;
    r1.x = r1.x * r1.z;
    r1.x = max(9.99999997e-07, r1.x);
    r5.z = r1.y ? r1.x : r5.y;
    r1.xy = r5.xz + -r0.yz;
    r0.yz = r0.ww * r1.xy + r0.yz;
  }
  r0.w = cmp(r5.x != 0.000000);
  r0.y = r0.y / r5.x;
  r1.z = r0.w ? r0.y : 1;
  r0.y = r0.z * r10.y;
  r0.y = 0.891250968 * r0.y;
  r0.y = r0.y / r2.z;
  r0.z = cmp(r0.y == 0.000000);
  r0.w = cmp(0 < r0.y);
  r1.w = cmp(r0.y < 0);
  r0.w = (int)-r0.w + (int)r1.w;
  r0.w = (int)r0.w;
  r0.y = log2(abs(r0.y));
  r0.y = 1.35135138 * r0.y;
  r0.y = exp2(r0.y);
  r0.y = r0.w * r0.y;
  r0.y = r0.z ? 0 : r0.y;
  r3.x = r5.w ? 0 : r6.w;
  r3.y = r0.y * r13.x;
  r3.z = r0.y * r12.x;
  r4.x = dot(float3(1, 0.277210057, 0.116094626), r3.xyz);
  r4.z = dot(float3(1, 0.0425858013, -0.753844559), r3.xyz);
  r4.y = r3.x;
  r0.yzw = log2(abs(r4.xyz));
  r0.yzw = float3(0.00746077253, 0.00746077253, 0.00746077253) * r0.yzw;
  r0.yzw = exp2(r0.yzw);
  r0.yzw = min(float3(1.00870001, 1.00870001, 1.00870001), r0.yzw);
  r2.yzw = cmp(float3(0.8359375, 0.8359375, 0.8359375) >= r0.yzw);
  r3.xyz = cmp(float3(0, 0, 0) < r4.xyz);
  r4.xyz = cmp(r4.xyz < float3(0, 0, 0));
  r3.xyz = (int3)-r3.xyz + (int3)r4.xyz;
  r3.xyz = (int3)r3.xyz;
  r4.xyz = float3(-0.8359375, -0.8359375, -0.8359375) + r0.yzw;
  r0.yzw = -r0.yzw * float3(18.6875, 18.6875, 18.6875) + float3(18.8515625, 18.8515625, 18.8515625);
  r0.yzw = r4.xyz / r0.yzw;
  r0.yzw = log2(r0.yzw);
  r0.yzw = float3(6.27739477, 6.27739477, 6.27739477) * r0.yzw;
  r0.yzw = exp2(r0.yzw);
  r0.yzw = r3.xyz * r0.yzw;
  r0.yzw = float3(10000, 10000, 10000) * r0.yzw;
  r0.yzw = r2.yzw ? float3(0, 0, 0) : r0.yzw;
  r1.w = dot(float3(1.97340584, -0.996146977, -0.025673762), r0.yzw);
  r2.y = dot(float3(0.35064584, 0.708214223, -0.0463727117), r0.yzw);
  r3.z = dot(float3(-0.0898918733, -0.305277616, 1.51366293), r0.yzw);
  r0.y = r3.z * 0.150000006 + r1.w;
  r3.x = r0.y * r1.z;
  r0.y = -r0.y * 0.260869592 + r2.y;
  r3.y = r0.y * r1.z;
  r1.xyw = float3(0.869565248, 1.42857146, 1);
  r0.yzw = r3.xyz * r1.xyz;
  r1.xyz = hdr_enabled ? float3(1.71665096, -0.35567075, -0.253366232) : float3(3.24096918, -1.53738272, -0.498610646);
  r2.yzw = hdr_enabled ? float3(-0.66668427, 1.61648107, 0.0157685373) : float3(-0.969243646, 1.87596738, 0.0415550806);
  r3.xyz = hdr_enabled ? float3(0.0176398568, -0.042770613, 0.942103088) : float3(0.0556300804, -0.203976959, 1.05697155);
  r1.x = dot(r1.xyz, r0.yzw);
  r1.y = dot(r2.yzw, r0.yzw);
  r1.z = dot(r3.xyz, r0.yzw);
  r0.yzw = max(float3(0, 0, 0), r1.xyz);
  if (!hdr_enabled) {
    r1.xyz = float3(0.00999999978, 0.00999999978, 0.00999999978) * r0.yzw;
    r2.yzw = float3(0.129199997, 0.129199997, 0.129199997) * r0.yzw;
    r1.xyz = log2(r1.xyz);
    r1.xyz = float3(0.416666657, 0.416666657, 0.416666657) * r1.xyz;
    r1.xyz = exp2(r1.xyz);
    r1.xyz = r1.xyz * float3(1.05499995, 1.05499995, 1.05499995) + float3(-0.0549999997, -0.0549999997, -0.0549999997);
    r3.xyz = cmp(float3(0.313080013, 0.313080013, 0.313080013) >= r0.yzw);
    r1.xyz = r3.xyz ? r2.yzw : r1.xyz;

#if RENODX_TONE_MAP_TYPE  // output bt.2020 pq, sdr code path normally outputs bt709 srgb

    // linearize using 2.2 gamma
    // this emulates when developers mistakenly use sRGB gamma despite using 2.2 displays
    // r1.rgb = saturate(r1.rgb);
    // r1.rgb = renodx::color::gamma::DecodeSafe(r1.rgb, 2.2f);
    r1.rgb = renodx::color::srgb::DecodeSafe(r1.rgb);

    r1.rgb = renodx::color::bt2020::from::BT709(r1.rgb);
    r1.rgb = renodx::color::pq::EncodeSafe(r1.rgb, 100.f);  // hardcode brightness, scale later

#endif

  } else {
    r0.yzw = r0.yzw / r0.xxx;  // normalize brightness to 1.0, r0.x = 200.f

    // r2.yzw = cmp(float3(0, 0, 0) >= r0.yzw);
    // r3.xyz = log2(r0.yzw);
    // r3.xyz = contrast * r3.xyz;
    // r3.xyz = exp2(r3.xyz);
    // r2.yzw = r2.yzw ? float3(0, 0, 0) : r3.xyz;
    // r3.x = cmp(contrast >= 1);
    // r3.yzw = float3(2, 2, 2) + -r0.yzw;
    // r4.xyz = r3.yzw * r3.yzw;
    // r3.yzw = saturate(r4.xyz * r3.yzw);
    // r4.xyz = float3(1, 1, 1) + -r3.yzw;
    // r3.yzw = r3.yzw * r2.yzw;
    // r0.yzw = r0.yzw * r4.xyz + r3.yzw;
    // r0.yzw = r3.xxx ? r2.yzw : r0.yzw;
    // r0.xyz = r0.yzw * r0.xxx;
    // r0.xyz = game_nits * r0.xyz;
    // r0.w = 1.20000005 * r2.x;
    // r0.xyz = min(r0.xyz, r0.www);

    float mid_gray = renodx::color::y::from::AP1(r0.yzw); // decided against using this

    float3 untonemapped_bt709 = renodx::color::bt709::from::AP1(untonemapped_ap1);
    r0.rgb = ApplyUserToneMap(untonemapped_bt709, 0.18);
    r0.rgb = renodx::color::correct::GammaSafe(r0.rgb);
    r0.rgb = renodx::color::bt2020::from::BT709(r0.rgb);

    r1.rgb = renodx::color::pq::EncodeSafe(r0.rgb, 100.f);
  }
  r1.xyz = saturate(r1.xyz);
  u0[vThreadID] = r1;  // store_uav_typed u0.xyzw, vThreadID.xyzz, r1.xyzw
  return;
}
