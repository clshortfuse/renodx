#include "./output.hlsl"

// ---- Created with 3Dmigoto v1.4.1 on Thu Feb 12 17:02:20 2026
groupshared struct { float val[1]; } g1[16];
groupshared struct { float val[6]; } g0[32];

cbuffer c0 : register(b0)
{
  float2 input_texture0_size : packoffset(c0);
  float ui_brightness : packoffset(c0.z);
  float ui_blur_sigma : packoffset(c0.w);
}

RWTexture2D<float4> uav0 : register(u0);


// 3Dmigoto declarations
#define cmp -

[numthreads(32, 1, 1)]
void main(uint3 vThreadGroupID : SV_GroupID, uint3 vThreadIDInGroup : SV_GroupThreadID)
{
  float4 r0,r1,r2,r3,r4,r5,r6,r7,r8;
  uint4 bitmask, uiDest;
  float4 fDest;
  uav0.GetDimensions(uiDest.x, uiDest.y);
  r0.xy = uiDest.xy;
  r1.y = (uint)vThreadGroupID.x << 1;
  r2.x = (uint)vThreadIDInGroup.x >> 1;
  r2.y = (int)vThreadIDInGroup.x & 1;
  r0.z = cmp((uint)r2.x < 8);
  if (r0.z != 0) {
    r0.z = (int)r2.y * 12;
    bitmask.w = ((~(-1 << 31)) << 1) & 0xffffffff;  r0.w = (((uint)vThreadGroupID.x << 1) & bitmask.w) | ((uint)vThreadIDInGroup.x & ~bitmask.w);
    r1.w = (int)r0.x + -1;
    r3.x = min((uint)r1.w, (uint)r0.w);
    r3.yzw = float3(0,0,0);
    r3.xyz = uav0.Load(uint2(r3.xy)).xyz;
    g0[r2.x].val[r0.z/4] = r3.x;
    g0[r2.x].val[r0.z/4+1] = r3.y;
    g0[r2.x].val[r0.z/4+2] = r3.z;
  } else {
    r0.z = (int)r2.y * 12;
    r3.yzw = (int3)r2.xxx + int3(-8,-8,-8);
    bitmask.x = ((~(-1 << 31)) << 1) & 0xffffffff;  r3.x = (((uint)vThreadGroupID.x << 1) & bitmask.x) | ((uint)vThreadIDInGroup.x & ~bitmask.x);
    r4.xyzw = (int4)r0.xyyy + int4(-1,-1,-1,-1);
    r3.xyzw = min((uint4)r4.xyzw, (uint4)r3.xyzw);
    r3.xyz = uav0.Load(uint2(r3.xy)).xyz;
    g0[r2.x].val[r0.z/4] = r3.x;
    g0[r2.x].val[r0.z/4+1] = r3.y;
    g0[r2.x].val[r0.z/4+2] = r3.z;
  }
  r0.z = cmp((uint)vThreadIDInGroup.x < 16);
  if (r0.z != 0) {
    r0.z = ui_blur_sigma * ui_blur_sigma;
    r0.w = 6.28318548 * r0.z;
    r0.w = rsqrt(r0.w);
    r0.z = r0.z + r0.z;
    r0.z = rcp(r0.z);
    r1.w = (int)vThreadIDInGroup.x + -7;
    r1.w = (int)r1.w * (int)-r1.w;
    r1.w = (int)r1.w;
    r0.z = r1.w * r0.z;
    r0.z = 1.44269502 * r0.z;
    r0.z = exp2(r0.z);
    r0.z = r0.w * r0.z;
    g1[vThreadIDInGroup.x].val[0/4] = r0.z;
  }
  r3.xyzw = (int4)r0.xyyy + int4(-1,-1,-1,-1);
  r0.z = (int)r2.y * 12;
  r2.z = 8;
  r4.w = 1;
  r1.z = 0;
  r0.w = -1;
  while (true) {
    r1.w = cmp((uint)r1.z >= (uint)r0.y);
    if (r1.w != 0) break;
    r1.x = (int)r2.x + (int)r1.z;
    r5.xyzw = (int4)r1.yxxx + (int4)r2.yzzz;
    r1.xw = (int2)r0.ww & int2(16,0);
    r1.xw = (int2)r1.xw + (int2)r2.xy;
    r1.w = (int)r1.w * 12;
    r6.xyzw = min((uint4)r5.xyzw, (uint4)r3.xyzw);
    r5.xyz = uav0.Load(uint2(r6.xy)).xyz;

    // r5.xyz /= RENODX_DIFFUSE_WHITE_NITS;
    // float3 game_color = r5.xyz;

    g0[r1.x].val[r1.w/4] = r5.x;
    g0[r1.x].val[r1.w/4+1] = r5.y;
    g0[r1.x].val[r1.w/4+2] = r5.z;
    GroupMemoryBarrierWithGroupSync();
    r6.xyzw = float4(0,0,0,0);
    r1.x = -7;
    while (true) {
      r2.w = cmp((int)r1.x >= 7);
      if (r2.w != 0) break;
      r2.w = (int)r1.x + (int)r5.w;
      r2.w = (int)r2.w & 31;
      r1.xw = (int2)r1.xx + int2(1,7);
      r7.w = g1[r1.w].val[0/4];
      r5.x = g0[r2.w].val[r0.z/4];
      r5.y = g0[r2.w].val[r0.z/4+1];
      r5.z = g0[r2.w].val[r0.z/4+2];
      r7.xyz = r5.xyz * r7.www;
      r6.xyzw = r6.xyzw + r7.xyzw;
    }
    GroupMemoryBarrierWithGroupSync();
    r5.xyzw = (int4)r1.yzzz + (int4)r2.yxxx;
    float2 coords = r5.xy;
    r1.xw = cmp((uint2)r5.xw >= (uint2)r0.xy);
    r1.x = (int)r1.w | (int)r1.x;
    if (r1.x == 0) {
      r7.xyz = r6.xyz / r6.www;

      float4 output_color = r7;
      if (RENODX_TONE_MAP_TYPE != 0.f) {
        output_color.xyz = ScaleGameColorUI(output_color.xyz);
        output_color.w = 1;
      }
      else {
      r7.xyz = saturate(r7.xyz / ui_brightness);
      r8.x = saturate(dot(float3(1.63504004,-0.605629981,-0.0763500035), r7.xyz));
      r8.y = saturate(dot(float3(-0.12325,1.13884997,-0.0102899997), r7.xyz));
      r8.z = saturate(dot(float3(-0.0171600003,-0.101729997,1.21072996), r7.xyz));
      r7.xyz = log2(r8.xyz);
      r7.xyz = float3(0.45449999,0.45449999,0.45449999) * r7.xyz;
      r4.xyz = exp2(r7.xyz);
      output_color = r4;
      }
      uav0[uint2(r5.xy)] = output_color;
    }
    r1.z = (int)r1.z + 16;
    r0.w = cmp((int)r0.w == 0);
  }
  return;
}

// //
// // Generated by Microsoft (R) HLSL Shader Compiler 10.1
// //
// //
// // Note: shader requires additional functionality:
// //       Typed UAV Load Additional Formats
// //
// //
// // Buffer Definitions:
// //
// // cbuffer c0
// // {
// //
// //   float2 input_texture0_size;        // Offset:    0 Size:     8 [unused]
// //   float ui_brightness;               // Offset:    8 Size:     4
// //   float ui_blur_sigma;               // Offset:   12 Size:     4
// //
// // }
// //
// //
// // Resource Bindings:
// //
// // Name                                 Type  Format         Dim      HLSL Bind  Count
// // ------------------------------ ---------- ------- ----------- -------------- ------
// // uav0                                  UAV  float4          2d             u0      1
// // c0                                cbuffer      NA          NA            cb0      1
// //
// //
// //
// // Input signature:
// //
// // Name                 Index   Mask Register SysValue  Format   Used
// // -------------------- ----- ------ -------- -------- ------- ------
// // no Input
// //
// // Output signature:
// //
// // Name                 Index   Mask Register SysValue  Format   Used
// // -------------------- ----- ------ -------- -------- ------- ------
// // no Output
// 0x00000000 : cs_5_0
//       0x00000008 : dcl_globalFlags refactoringAllowed
//       0x0000000C : dcl_constantbuffer CB0[1], immediateIndexed
//       0x0000001C : dcl_uav_typed_texture2d(float, float, float, float) u0
//       0x0000002C : dcl_input vThreadGroupID.x
//       0x00000034 : dcl_input vThreadIDInGroup.x
//       0x0000003C : dcl_temps 9
//       0x00000044 : dcl_tgsm_structured g0, 24, 32
//       0x00000058 : dcl_tgsm_structured g1, 4, 16
//       0x0000006C : dcl_thread_group 32, 1, 1
//    0 0x0000007C : resinfo_indexable(texture2d)(float, float, float, float) _uint r0.xy, l(0), u0.xyzw
//    1 0x000000A0 : ishl r1.y, vThreadGroupID.x, l(1)
//    2 0x000000B8 : ushr r2.x, vThreadIDInGroup.x, l(1)
//    3 0x000000D0 : and r2.y, vThreadIDInGroup.x, l(1)
//    4 0x000000E8 : ult r0.z, r2.x, l(8)
//    5 0x00000104 : if_nz r0.z
//    6 0x00000110 : imul null, r0.z, r2.y, l(12)
//    7 0x00000130 : bfi r0.w, l(31), l(1), vThreadGroupID.x, vThreadIDInGroup.x
//    8 0x00000154 : iadd r1.w, r0.x, l(-1)
//    9 0x00000170 : umin r3.x, r0.w, r1.w
//   10 0x0000018C : mov r3.yzw, l(0, 0, 0, 0)
//   11 0x000001AC : ld_uav_typed_indexable(texture2d)(float, float, float, float) r3.xyz, r3.xyzw, u0.xyzw
//   12 0x000001D0 : store_structured g0.xyz, r2.x, r0.z, r3.xyzx
//   13 0x000001F4 : else 
//   14 0x000001F8 : imul null, r0.z, r2.y, l(12)
//   15 0x00000218 : iadd r3.yzw, r2.xxxx, l(0, -8, -8, -8)
//   16 0x00000240 : bfi r3.x, l(31), l(1), vThreadGroupID.x, vThreadIDInGroup.x
//   17 0x00000264 : iadd r4.xyzw, r0.xyyy, l(-1, -1, -1, -1)
//   18 0x0000028C : umin r3.xyzw, r3.xyzw, r4.xyzw
//   19 0x000002A8 : ld_uav_typed_indexable(texture2d)(float, float, float, float) r3.xyz, r3.xyzw, u0.xyzw
//   20 0x000002CC : store_structured g0.xyz, r2.x, r0.z, r3.xyzx
//   21 0x000002F0 : endif 
//   22 0x000002F4 : ult r0.z, vThreadIDInGroup.x, l(16)
//   23 0x0000030C : if_nz r0.z
//   24 0x00000318 : mul r0.z, cb0[0].w, cb0[0].w
//   25 0x0000033C : mul r0.w, r0.z, l(6.283185)
//   26 0x00000358 : rsq r0.w, r0.w
//   27 0x0000036C : add r0.z, r0.z, r0.z
//   28 0x00000388 : rcp r0.z, r0.z
//   29 0x0000039C : iadd r1.w, vThreadIDInGroup.x, l(-7)
//   30 0x000003B4 : imul null, r1.w, r1.w, -r1.w
//   31 0x000003D8 : itof r1.w, r1.w
//   32 0x000003EC : mul r0.z, r0.z, r1.w
//   33 0x00000408 : mul r0.z, r0.z, l(1.442695)
//   34 0x00000424 : exp r0.z, r0.z
//   35 0x00000438 : mul r0.z, r0.z, r0.w
//   36 0x00000454 : store_structured g1.x, vThreadIDInGroup.x, l(0), r0.z
//   37 0x00000474 : endif 
//   38 0x00000478 : iadd r3.xyzw, r0.xyyy, l(-1, -1, -1, -1)
//   39 0x000004A0 : imul null, r0.z, r2.y, l(12)
//   40 0x000004C0 : mov r2.z, l(8)
//   41 0x000004D4 : mov r4.w, l(1.000000)
//   42 0x000004E8 : mov r1.z, l(0)
//   43 0x000004FC : mov r0.w, l(-1)
//   44 0x00000510 : loop 
//   45 0x00000514 : uge r1.w, r1.z, r0.y
//   46 0x00000530 : breakc_nz r1.w
//   47 0x0000053C : iadd r1.x, r2.x, r1.z
//   48 0x00000558 : iadd r5.xyzw, r1.yxxx, r2.yzzz
//   49 0x00000574 : and r1.xw, r0.wwww, l(16, 0, 0, 0)
//   50 0x0000059C : iadd r1.xw, r1.xxxw, r2.xxxy
//   51 0x000005B8 : imul null, r1.w, r1.w, l(12)
//   52 0x000005D8 : umin r6.xyzw, r3.xyzw, r5.xyzw
//   53 0x000005F4 : ld_uav_typed_indexable(texture2d)(float, float, float, float) r5.xyz, r6.xyzw, u0.xyzw
//   54 0x00000618 : store_structured g0.xyz, r1.x, r1.w, r5.xyzx
//   55 0x0000063C : sync_g_t
//   56 0x00000640 : mov r6.xyzw, l(0, 0, 0, 0)
//   57 0x00000660 : mov r1.x, l(-7)
//   58 0x00000674 : loop 
//   59 0x00000678 : ige r2.w, r1.x, l(7)
//   60 0x00000694 : breakc_nz r2.w
//   61 0x000006A0 : iadd r2.w, r1.x, r5.w
//   62 0x000006BC : and r2.w, r2.w, l(31)
//   63 0x000006D8 : iadd r1.xw, r1.xxxx, l(1, 0, 0, 7)
//   64 0x00000700 : ld_structured r7.w, r1.w, l(0), g1.xxxx
//   65 0x00000724 : ld_structured r5.xyz, r2.w, r0.z, g0.xyzx
//   66 0x00000748 : mul r7.xyz, r7.wwww, r5.xyzx
//   67 0x00000764 : add r6.xyzw, r7.xyzw, r6.xyzw
//   68 0x00000780 : endloop 
//   69 0x00000784 : sync_g_t
//   70 0x00000788 : iadd r5.xyzw, r1.yzzz, r2.yxxx
//   71 0x000007A4 : uge r1.xw, r5.xxxw, r0.xxxy
//   72 0x000007C0 : or r1.x, r1.w, r1.x
//   73 0x000007DC : if_z r1.x
//   74 0x000007E8 : div r7.xyz, r6.xyzx, r6.wwww
//   75 0x00000804 : div_sat r7.xyz, r7.xyzx, cb0[0].zzzz
//   76 0x00000824 : dp3_sat r8.x, l(1.635040, -0.605630, -0.076350, 0.000000), r7.xyzx
//   77 0x0000084C : dp3_sat r8.y, l(-0.123250, 1.138850, -0.010290, 0.000000), r7.xyzx
//   78 0x00000874 : dp3_sat r8.z, l(-0.017160, -0.101730, 1.210730, 0.000000), r7.xyzx
//   79 0x0000089C : log r7.xyz, r8.xyzx
//   80 0x000008B0 : mul r7.xyz, r7.xyzx, l(0.454500, 0.454500, 0.454500, 0.000000)
//   81 0x000008D8 : exp r4.xyz, r7.xyzx
//   82 0x000008EC : store_uav_typed u0.xyzw, r5.xyzw, r4.xyzw
//   83 0x00000908 : endif 
//   84 0x0000090C : iadd r1.z, r1.z, l(16)
//   85 0x00000928 : ieq r0.w, r0.w, l(0)
//   86 0x00000944 : endloop 
//   87 0x00000948 : ret
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // Approximately 88 instruction slots used
